<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸Šæµ·äº¤é€šå¤§å­¦é£Ÿå ‚ç¤¾åŒº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* å›ºå®šçš„SJTUèƒŒæ™¯æ–‡å­— */
        .sjtu-background {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 300px;
            font-weight: 600;
            color: rgba(30, 144, 255, 0.15);
            z-index: 1;
            pointer-events: none;
            user-select: none;
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            text-shadow: 0 0 20px rgba(30, 144, 255, 0.2);
            opacity: 0.6;
            letter-spacing: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        /* ç”¨æˆ·ç™»å½•åŒºåŸŸ */
        .user-section {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
        }

        .login-btn, .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .login-btn:hover, .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        /* ç™»å½•å¼¹çª—æ ·å¼ */
        .login-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .login-modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 500;
            color: #2c3e50;
        }

        .form-input {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .login-submit {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .filter-dishes-btn {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3);
        }

        .filter-dishes-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(142, 68, 173, 0.4);
        }

        .filter-toggle-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }

        .filter-toggle-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .filter-toggle-btn.active {
            background: #27ae60;
            box-shadow: 0 3px 10px rgba(39, 174, 96, 0.3);
        }

        .filter-toggle-btn.active:hover {
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        }

        .canteen-grid {
            display: flex;
            flex-direction: column;
            gap: 30px;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .canteen-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            width: 100%;
        }

        .canteen-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        .canteen-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .canteen-title:hover {
            color: #3498db;
        }

        .canteen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .canteen-toggle-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .canteen-toggle-btn:hover {
            background: #c0392b;
        }

        .stalls-container {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .stalls-container.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }

        .stalls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stall {
            background: white;
            border-radius: 12px;
            padding: 15px;
            border-left: 4px solid #e74c3c;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .stall:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .stall-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .stall-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
            cursor: pointer;
        }

        .toggle-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s ease;
        }

        .toggle-btn:hover {
            background: #2980b9;
        }

        .dishes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .dishes.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }


        .stall-rating {
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
        }

        .stall-rating.high {
            background: #27ae60; /* ç»¿è‰² - 4åˆ†ä»¥ä¸Š */
        }

        .stall-rating.medium {
            background: #f39c12; /* é»„è‰² - 3åˆ°4åˆ† */
        }

        .stall-rating.low {
            background: #e74c3c; /* çº¢è‰² - 3åˆ†ä»¥ä¸‹ */
        }

        .dishes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .dish {
            background: #ecf0f1;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #bdc3c7;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dish:hover {
            background: #d5dbdb;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .dish-name {
            font-weight: bold;
            color: #34495e;
            margin-bottom: 5px;
        }

        .dish-price {
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .dish-attributes {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .attribute-tag {
            background: #3498db;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .spicy-tag {
            background: #e74c3c;
        }

        .heat-tag {
            background: #f39c12;
        }

        .onion-tag {
            background: #27ae60;
        }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #000;
        }

        .modal-header {
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .rating-display {
            background: #f39c12;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            font-weight: bold;
        }

        .comments-section {
            margin-top: 20px;
        }

        .comment {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .comment-author {
            font-weight: bold;
            color: #2c3e50;
        }

        .comment-rating {
            color: #f39c12;
            font-weight: bold;
        }

        .comment-date {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .comment-text {
            color: #34495e;
            line-height: 1.5;
        }

        /* å½“å‰ç”¨æˆ·è¯„è®ºæ ·å¼ */
        .current-user-comment {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            border-left-color: #9c27b0;
            position: relative;
        }

        .current-user-badge {
            background: #9c27b0;
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
            font-weight: 500;
        }

        .add-comment {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .add-comment h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .comment-input {
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1em;
            resize: vertical;
            min-height: 80px;
        }

        .comment-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .rating-input {
            padding: 8px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1em;
        }

        .submit-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .submit-btn:hover {
            background: #2980b9;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ç­›é€‰å¼¹çª—æ ·å¼ */
        .filter-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .filter-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .filter-step {
            display: none;
            text-align: center;
        }

        .filter-step.active {
            display: block;
        }

        .filter-step h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        .filter-option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
            font-weight: 500;
        }

        .filter-option:hover {
            background: #e9ecef;
            border-color: #3498db;
        }

        .filter-option.selected {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .filter-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .filter-nav-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .filter-nav-btn:hover {
            background: #5a6268;
        }

        .filter-nav-btn.primary {
            background: #3498db;
        }

        .filter-nav-btn.primary:hover {
            background: #2980b9;
        }

        .filter-nav-btn:disabled {
            background: #dee2e6;
            cursor: not-allowed;
        }

        .search-bar {
            margin: 20px 30px;
            text-align: center;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 500px;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 1.1em;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            border-color: #3498db;
        }

        .search-btn {
            position: absolute;
            right: 5px;
            background: #3498db;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
        }

        .search-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
        }

        .search-btn:active {
            transform: scale(0.95);
        }

        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .filter-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group h4 {
            color: #34495e;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .filter-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 0.9em;
        }

        .filter-btn:hover, .filter-btn.active {
            background: #229954;
        }

        .price-range {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .price-input {
            width: 80px;
            padding: 8px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            text-align: center;
        }

        .price-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .rating-range {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .rating-input {
            width: 60px;
            padding: 8px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            text-align: center;
        }

        .rating-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .stats {
            background: #ecf0f1;
            padding: 20px;
            margin: 20px 30px;
            border-radius: 10px;
            text-align: center;
        }

        .stats h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 15px;
                margin: 0;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .header div {
                flex-direction: row;
                gap: 10px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .filter-dishes-btn, .filter-toggle-btn {
                padding: 10px 15px;
                font-size: 0.9em;
                flex: 1;
                min-width: 80px;
                max-width: 120px;
            }
            
            .search-bar {
                margin: 15px 20px;
            }
            
            .search-container {
                max-width: 100%;
            }
            
            .search-input {
                padding: 12px 45px 12px 12px;
                font-size: 1em;
            }
            
            .search-btn {
                width: 35px;
                height: 35px;
                font-size: 1em;
            }
            
            .filter-section {
                margin: 15px 20px;
                padding: 15px;
            }
            
            .filter-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .filter-btn {
                width: 100%;
                max-width: 200px;
                margin: 5px 0;
            }
            
            .price-range, .rating-range {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .price-input, .rating-input {
                width: 120px;
            }
            
            .stats {
                margin: 15px 20px;
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .canteen-grid {
                padding: 15px;
            }
            
            .canteen-card {
                padding: 15px;
            }
            
            .canteen-title {
                font-size: 1.4em;
            }
            
            .stalls-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .stall {
                padding: 12px;
            }
            
            .stall-name {
                font-size: 1em;
            }
            
            .dishes {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .dish {
                padding: 8px;
            }
            
            .dish-name {
                font-size: 0.9em;
            }
            
            .dish-price {
                font-size: 1em;
            }
            
            .attribute-tag {
                font-size: 0.7em;
                padding: 1px 4px;
            }
            
            /* SJTUèƒŒæ™¯æ–‡å­—ç§»åŠ¨ç«¯é€‚é… */
            .sjtu-background {
                font-size: 150px;
                letter-spacing: 5px;
            }
            
            /* å¼¹çª—ç§»åŠ¨ç«¯é€‚é… */
            .modal-content, .filter-modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
                max-height: 85vh;
            }
            
            .modal-title {
                font-size: 1.2em;
            }
            
            .comment-form {
                gap: 10px;
            }
            
            .comment-input {
                min-height: 60px;
                font-size: 0.9em;
            }
            
            .rating-input {
                font-size: 0.9em;
            }
            
            .submit-btn {
                padding: 10px 20px;
                font-size: 0.9em;
            }
            
            /* ç­›é€‰å¼¹çª—ç§»åŠ¨ç«¯é€‚é… */
            .filter-option {
                padding: 12px 15px;
                font-size: 1em;
            }
            
            .filter-nav {
                flex-direction: column;
                gap: 10px;
            }
            
            .filter-nav-btn {
                width: 100%;
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }
            
            .header {
                padding: 15px 10px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .header div {
                gap: 8px;
            }
            
            .filter-dishes-btn, .filter-toggle-btn {
                padding: 8px 12px;
                font-size: 0.8em;
                min-width: 70px;
                max-width: 100px;
            }
            
            .search-bar, .filter-section, .stats {
                margin: 10px 15px;
            }
            
            .search-input {
                padding: 10px 40px 10px 10px;
                font-size: 0.9em;
            }
            
            .search-btn {
                width: 30px;
                height: 30px;
                font-size: 0.9em;
            }
            
            .canteen-grid {
                padding: 10px;
            }
            
            .canteen-card {
                padding: 10px;
            }
            
            .canteen-title {
                font-size: 1.2em;
            }
            
            .stall {
                padding: 10px;
            }
            
            .stall-name {
                font-size: 0.9em;
            }
            
            .dish {
                padding: 6px;
            }
            
            .dish-name {
                font-size: 0.8em;
            }
            
            .dish-price {
                font-size: 0.9em;
            }
            
            .attribute-tag {
                font-size: 0.6em;
                padding: 1px 3px;
            }
            
            /* SJTUèƒŒæ™¯æ–‡å­—å°å±å¹•é€‚é… */
            .sjtu-background {
                font-size: 100px;
                letter-spacing: 3px;
            }
            
            /* å¼¹çª—å°å±å¹•é€‚é… */
            .modal-content, .filter-modal-content {
                width: 98%;
                margin: 5% auto;
                padding: 15px;
            }
            
            .modal-title {
                font-size: 1.1em;
            }
            
            .comment-input {
                min-height: 50px;
                font-size: 0.8em;
            }
            
            .rating-input {
                font-size: 0.8em;
            }
            
            .submit-btn {
                padding: 8px 15px;
                font-size: 0.8em;
            }
            
            .filter-option {
                padding: 10px 12px;
                font-size: 0.9em;
            }
            
            .filter-nav-btn {
                padding: 10px;
                font-size: 0.9em;
            }
        }

        /* æ¨ªå±é€‚é… */
        @media (max-width: 768px) and (orientation: landscape) {
            .sjtu-background {
                font-size: 120px;
                letter-spacing: 4px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.6em;
            }
            
            .modal-content, .filter-modal-content {
                max-height: 90vh;
            }
        }

        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .dish:hover, .stall:hover, .canteen-card:hover {
                transform: none;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }
            
            .filter-btn:hover, .filter-toggle-btn:hover, .filter-dishes-btn:hover {
                transform: none;
            }
            
            .toggle-btn:hover, .canteen-toggle-btn:hover {
                transform: none;
            }
            
            .submit-btn:hover {
                transform: none;
            }
            
            /* å¢åŠ è§¦æ‘¸ç›®æ ‡å¤§å° */
            .dish, .stall-header, .canteen-title {
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            
            .filter-btn, .filter-toggle-btn, .filter-dishes-btn, .toggle-btn, .canteen-toggle-btn {
                min-height: 44px;
                min-width: 44px;
            }
        }
    </style>
</head>
<body>
    <!-- å›ºå®šçš„SJTUèƒŒæ™¯æ–‡å­— -->
    <div class="sjtu-background">SJTU</div>
    
    <div class="container">
        <div class="header">
            <!-- ç”¨æˆ·ç™»å½•åŒºåŸŸ -->
            <div class="user-section">
                <div id="userInfo" class="user-info" style="display: none;">
                    <div class="user-avatar" id="userAvatar"></div>
                    <span class="user-name" id="userName"></span>
                </div>
                <button id="loginBtn" class="login-btn" onclick="showLoginModal()">ç™»å½•</button>
                <button id="logoutBtn" class="logout-btn" onclick="logout()" style="display: none;">é€€å‡º</button>
            </div>
            
            <h1>ğŸ½ï¸ ä¸Šæµ·äº¤é€šå¤§å­¦é£Ÿå ‚ç¤¾åŒº</h1>
            <p>å‘ç°ç¾é£Ÿï¼Œåˆ†äº«ä½“éªŒï¼Œè®©æ¯ä¸€é¤éƒ½æ›´ç²¾å½©</p>
            <div style="margin-top: 20px; display: flex; justify-content: center; align-items: center; gap: 20px;">
                <button id="slimBtn" class="filter-toggle-btn" onclick="toggleSlimFilter()">ç˜¦èº«</button>
                <button id="filterDishesBtn" class="filter-dishes-btn" onclick="showFilterModal()">ç­›é€‰èœå“</button>
                <button id="fitnessBtn" class="filter-toggle-btn" onclick="toggleFitnessFilter()">å¥èº«</button>
            </div>
        </div>

        <div class="search-bar">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="æœç´¢èœå“æˆ–é¤é¥®å¤§æ¥¼" id="searchInput">
                <button class="search-btn" onclick="performSearch()" title="æœç´¢">
                    ğŸ”
                </button>
            </div>
        </div>

        <div class="filter-section">
            <h3>ğŸ” ç­›é€‰æ¡ä»¶</h3>
            
            <div class="filter-group">
                <h4>ğŸŒ¶ï¸ è¾£åº¦ç­›é€‰</h4>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterBySpicy('all')">å…¨éƒ¨</button>
                    <button class="filter-btn" onclick="filterBySpicy('ä¸è¾£')">ä¸è¾£</button>
                    <button class="filter-btn" onclick="filterBySpicy('å¾®è¾£')">å¾®è¾£</button>
                    <button class="filter-btn" onclick="filterBySpicy('ä¸­è¾£')">ä¸­è¾£</button>
                    <button class="filter-btn" onclick="filterBySpicy('éº»è¾£')">éº»è¾£</button>
                </div>
            </div>

            <div class="filter-group">
                <h4>â­ è¯„åˆ†ç­›é€‰</h4>
                <div class="rating-range">
                    <span>è¯„åˆ†èŒƒå›´ï¼š</span>
                    <input type="number" class="rating-input" id="minRating" placeholder="æœ€ä½" min="1" max="5" step="0.1">
                    <span>-</span>
                    <input type="number" class="rating-input" id="maxRating" placeholder="æœ€é«˜" min="1" max="5" step="0.1">
                    <button class="filter-btn" onclick="filterByRating()">ç­›é€‰è¯„åˆ†</button>
                </div>
            </div>

            <div class="filter-group">
                <h4>ğŸ’° ä»·æ ¼ç­›é€‰</h4>
                <div class="price-range">
                    <span>ä»·æ ¼èŒƒå›´ï¼š</span>
                    <input type="number" class="price-input" id="minPrice" placeholder="æœ€ä½" min="0" step="1">
                    <span>å…ƒ -</span>
                    <input type="number" class="price-input" id="maxPrice" placeholder="æœ€é«˜" min="0" step="1">
                    <span>å…ƒ</span>
                    <button class="filter-btn" onclick="filterByPrice()">ç­›é€‰ä»·æ ¼</button>
                </div>
            </div>

            <div class="filter-group">
                <div class="filter-buttons">
                    <button class="filter-btn" onclick="clearAllFilters()">æ¸…é™¤æ‰€æœ‰ç­›é€‰</button>
                </div>
            </div>
        </div>

        <div class="stats">
            <h3>ğŸ“Š é£Ÿå ‚ç»Ÿè®¡</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <strong>é¤é¥®å¤§æ¥¼</strong><br>
                    <span style="color: #3498db; font-size: 1.5em;">7</span> æ ‹
                </div>
                <div class="stat-item">
                    <strong>æ‘Šä½æ€»æ•°</strong><br>
                    <span style="color: #e74c3c; font-size: 1.5em;">35</span> ä¸ª
                </div>
                <div class="stat-item">
                    <strong>èœå“æ€»æ•°</strong><br>
                    <span style="color: #f39c12; font-size: 1.5em;">156</span> é“
                </div>
                <div class="stat-item">
                    <strong>å¹³å‡è¯„åˆ†</strong><br>
                    <span style="color: #27ae60; font-size: 1.5em;">3.0</span> â­
                </div>
            </div>
        </div>

        <div class="canteen-grid" id="canteenGrid">
            <!-- é¤é¥®å¤§æ¥¼å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- ç™»å½•å¼¹çª— -->
    <div id="loginModal" class="login-modal">
        <div class="login-modal-content">
            <span class="close" onclick="closeLoginModal()">&times;</span>
            <h2 style="text-align: center; margin-bottom: 20px; color: #2c3e50;">ç”¨æˆ·ç™»å½•</h2>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" class="form-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <label for="userEmail">é‚®ç®±ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="email" id="userEmail" class="form-input" placeholder="è¯·è¾“å…¥é‚®ç®±">
                </div>
                <button type="submit" class="login-submit">ç™»å½•</button>
            </form>
            <p style="text-align: center; margin-top: 15px; color: #7f8c8d; font-size: 14px;">
                ç™»å½•åå¯ä»¥å‘è¡¨è¯„è®ºå’Œè¯„åˆ†ï¼Œä¸åŒç”¨æˆ·çš„è¯„è®ºä¼šåˆ†åˆ«æ˜¾ç¤º
            </p>
        </div>
    </div>

    <!-- ç­›é€‰å¼¹çª— -->
    <div id="filterModal" class="filter-modal">
        <div class="filter-modal-content">
            <span class="close" onclick="closeFilterModal()">&times;</span>
            
            <!-- ç¬¬ä¸€æ­¥ï¼šè¾£åº¦ç­›é€‰ -->
            <div id="step1" class="filter-step active">
                <h3>ğŸŒ¶ï¸ è¯·é€‰æ‹©è¾£åº¦åå¥½</h3>
                <div class="filter-options">
                    <div class="filter-option" onclick="selectSpicy('è¾£')">è¾£</div>
                    <div class="filter-option" onclick="selectSpicy('ä¸è¾£')">ä¸è¾£</div>
                    <div class="filter-option" onclick="selectSpicy('è¾£ä¸è¾£çš†å¯')">è¾£ä¸è¾£çš†å¯</div>
                </div>
                <div class="filter-nav">
                    <button class="filter-nav-btn" onclick="closeFilterModal()">å–æ¶ˆ</button>
                    <button class="filter-nav-btn primary" onclick="nextStep(2)" disabled id="nextBtn1">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <!-- ç¬¬äºŒæ­¥ï¼šä½ç½®ç­›é€‰ -->
            <div id="step2" class="filter-step">
                <h3>ğŸ“ è¯·é€‰æ‹©æ‚¨çš„ä½ç½®</h3>
                <div class="filter-options">
                    <div class="filter-option" onclick="selectLocation('ä¸œ34å®¿èˆ')">ä¸œ34å®¿èˆ</div>
                    <div class="filter-option" onclick="selectLocation('ä¸Š/ä¸­/ä¸‹é™¢')">ä¸Š/ä¸­/ä¸‹é™¢</div>
                    <div class="filter-option" onclick="selectLocation('ä¸œä¸Š/ä¸­/ä¸‹é™¢')">ä¸œä¸Š/ä¸­/ä¸‹é™¢</div>
                </div>
                <div class="filter-nav">
                    <button class="filter-nav-btn" onclick="prevStep(1)">ä¸Šä¸€æ­¥</button>
                    <button class="filter-nav-btn primary" onclick="nextStep(3)" disabled id="nextBtn2">ä¸‹ä¸€æ­¥</button>
                </div>
            </div>

            <!-- ç¬¬ä¸‰æ­¥ï¼šä¼˜å…ˆçº§ç­›é€‰ -->
            <div id="step3" class="filter-step">
                <h3>âš–ï¸ è¯·é€‰æ‹©ä¼˜å…ˆçº§åå¥½</h3>
                <div class="filter-options">
                    <div class="filter-option" onclick="selectPriority('æ—¶é—´ä¸ºé‡')">æ—¶é—´ä¸ºé‡</div>
                    <div class="filter-option" onclick="selectPriority('å£å‘³ä¸ºé‡')">å£å‘³ä¸ºé‡</div>
                    <div class="filter-option" onclick="selectPriority('äºŒè€…å…¼é¡¾')">äºŒè€…å…¼é¡¾</div>
                </div>
                <div class="filter-nav">
                    <button class="filter-nav-btn" onclick="prevStep(2)">ä¸Šä¸€æ­¥</button>
                    <button class="filter-nav-btn primary" onclick="applyFilter()">å®Œæˆç­›é€‰</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯„è®ºå¼¹çª— -->
    <div id="commentModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
                <div class="rating-display" id="modalRating"></div>
            </div>
            <div class="comments-section">
                <h4>ğŸ’¬ ç”¨æˆ·è¯„ä»·</h4>
                <div id="commentsList"></div>
                <div class="add-comment">
                    <h4>âœï¸ æ·»åŠ è¯„ä»·</h4>
                    <form class="comment-form" id="commentForm">
                        <textarea class="comment-input" id="commentText" placeholder="åˆ†äº«ä½ çš„ç”¨é¤ä½“éªŒ..." required></textarea>
                        <select class="rating-input" id="commentRating" required>
                            <option value="">é€‰æ‹©è¯„åˆ†</option>
                            <option value="1">1â­ - å¾ˆå·®</option>
                            <option value="2">2â­ - ä¸€èˆ¬</option>
                            <option value="3">3â­ - è¿˜è¡Œ</option>
                            <option value="4">4â­ - ä¸é”™</option>
                            <option value="5">5â­ - å¾ˆæ£’</option>
                        </select>
                        <button type="submit" class="submit-btn">æäº¤è¯„ä»·</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç”¨æˆ·ç³»ç»Ÿ
        let currentUser = null;
        let allComments = {}; // å­˜å‚¨æ‰€æœ‰ç”¨æˆ·çš„è¯„è®º {dishId: {userId: {comment, rating, date, username}}}

        // ç”¨æˆ·ç™»å½•åŠŸèƒ½
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åï¼');
                return;
            }

            // åˆ›å»ºç”¨æˆ·å¯¹è±¡
            currentUser = {
                id: generateUserId(),
                username: username,
                email: email,
                avatar: username.charAt(0).toUpperCase(),
                loginTime: new Date().toISOString()
            };

            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // æ›´æ–°UI
            updateUserInterface();
            
            // å…³é—­ç™»å½•å¼¹çª—
            closeLoginModal();
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('username').value = '';
            document.getElementById('userEmail').value = '';
            
            // é‡æ–°åŠ è½½è¯„è®º
            loadAllComments();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            updateUserInterface();
            loadAllComments();
        }

        function updateUserInterface() {
            const userInfo = document.getElementById('userInfo');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');

            if (currentUser) {
                userInfo.style.display = 'flex';
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                userAvatar.textContent = currentUser.avatar;
                userName.textContent = currentUser.username;
            } else {
                userInfo.style.display = 'none';
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
            }
        }

        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // åŠ è½½æ‰€æœ‰è¯„è®º
        function loadAllComments() {
            const savedComments = localStorage.getItem('allComments');
            if (savedComments) {
                allComments = JSON.parse(savedComments);
            }
        }

        // ä¿å­˜æ‰€æœ‰è¯„è®º
        function saveAllComments() {
            localStorage.setItem('allComments', JSON.stringify(allComments));
        }

        // è·å–èœå“çš„å”¯ä¸€ID
        function getDishId(canteenName, stallName, dishIndex) {
            return `${canteenName}_${stallName}_${dishIndex}`;
        }

        // è¾£åº¦é€‰é¡¹
        const spicyLevels = ['ä¸è¾£', 'å¾®è¾£', 'ä¸­è¾£', 'éº»è¾£'];
        
        // å…¶ä»–å±æ€§é€‰é¡¹
        const attributes = ['åŠ è‘±', 'é«˜è„‚', 'ç´ é£Ÿ', 'æ¸…çœŸ', 'ä½ç›', 'æ— ç³–', 'é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£', 'ç”œå£'];

        // ç”Ÿæˆéšæœºå±æ€§
        function getRandomAttributes() {
            const numAttributes = Math.floor(Math.random() * 3) + 1; // 1-3ä¸ªå±æ€§
            const shuffled = attributes.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, numAttributes);
        }

        // ç”Ÿæˆéšæœºè¾£åº¦
        function getRandomSpicy() {
            return spicyLevels[Math.floor(Math.random() * spicyLevels.length)];
        }

        // ç”Ÿæˆéšæœºè¯„è®º
        function generateRandomComments() {
            // æ­£é¢è¯„è®ºï¼ˆ4-5åˆ†ï¼‰
            const positiveComments = [
                { text: 'å‘³é“ä¸é”™ï¼Œåˆ†é‡è¶³ï¼', rating: 4 },
                { text: 'ä»·æ ¼å®æƒ ï¼Œæ€§ä»·æ¯”é«˜', rating: 4 },
                { text: 'æœåŠ¡æ€åº¦å¾ˆå¥½', rating: 4 },
                { text: 'èœå“æ–°é²œï¼Œå£æ„Ÿå¥½', rating: 5 },
                { text: 'ç¯å¢ƒå¹²å‡€æ•´æ´', rating: 4 },
                { text: 'æ¨èå°è¯•ï¼', rating: 5 },
                { text: 'ä¸‹æ¬¡è¿˜ä¼šå†æ¥', rating: 4 },
                { text: 'å‘³é“å¾ˆæ­£å®—ï¼Œæ¨èï¼', rating: 5 },
                { text: 'æœåŠ¡é€Ÿåº¦å¾ˆå¿«', rating: 4 },
                { text: 'èœå“å¾ˆæ–°é²œï¼Œå£æ„Ÿä¸é”™', rating: 4 },
                { text: 'å‘³é“ä¸é”™ï¼Œå€¼å¾—ä¸€è¯•', rating: 4 },
                { text: 'åˆ†é‡å¾ˆè¶³ï¼Œæ€§ä»·æ¯”é«˜', rating: 4 },
                { text: 'æœåŠ¡å¾ˆå‘¨åˆ°ï¼Œå¾ˆæ»¡æ„', rating: 5 },
                { text: 'ç¯å¢ƒä¸é”™ï¼Œé€‚åˆèšé¤', rating: 4 },
                { text: 'ä»·æ ¼åˆç†ï¼Œå‘³é“ä¸é”™', rating: 4 },
                { text: 'æœåŠ¡æ€åº¦å¾ˆå¥½ï¼Œå¾ˆè´´å¿ƒ', rating: 5 },
                { text: 'ç¯å¢ƒå¹²å‡€ï¼Œç”¨é¤èˆ’é€‚', rating: 4 }
            ];
            
            // ä¸­æ€§è¯„è®ºï¼ˆ3åˆ†ï¼‰
            const neutralComments = [
                { text: 'å‘³é“ä¸€èˆ¬ï¼Œæ²¡æœ‰ç‰¹åˆ«æƒŠè‰³', rating: 3 },
                { text: 'å‘³é“è¿˜å¯ä»¥ï¼Œä¸­è§„ä¸­çŸ©', rating: 3 },
                { text: 'åˆ†é‡åˆšå¥½ï¼Œä»·æ ¼åˆç†', rating: 3 },
                { text: 'æœåŠ¡æ€åº¦ä¸€èˆ¬', rating: 3 },
                { text: 'å‘³é“ä¸€èˆ¬ï¼Œæ²¡æœ‰ç‰¹è‰²', rating: 3 }
            ];
            
            // è´Ÿé¢è¯„è®ºï¼ˆ1-2åˆ†ï¼‰
            const negativeComments = [
                { text: 'æ’é˜Ÿæ—¶é—´æœ‰ç‚¹é•¿', rating: 2 },
                { text: 'åˆ†é‡æœ‰ç‚¹å°‘ï¼Œåƒä¸é¥±', rating: 2 },
                { text: 'ä»·æ ¼åè´µï¼Œæ€§ä»·æ¯”ä¸é«˜', rating: 2 },
                { text: 'ç¯å¢ƒæœ‰ç‚¹åµ', rating: 2 },
                { text: 'æ’é˜Ÿäººå¾ˆå¤šï¼Œç­‰äº†å¥½ä¹…', rating: 1 },
                { text: 'åˆ†é‡å¤ªå°‘ï¼Œä¸å¤Ÿåƒ', rating: 1 },
                { text: 'ä»·æ ¼æœ‰ç‚¹è´µï¼Œä½†å‘³é“å¥½', rating: 2 }
            ];
            
            const authors = ['å°æ˜', 'å°çº¢', 'å°æ', 'å°ç‹', 'å°å¼ ', 'å°åˆ˜', 'å°é™ˆ', 'å°æ¨', 'å°èµµ', 'å°å­™', 'å°å‘¨', 'å°å´', 'å°éƒ‘', 'å°å†¯', 'å°é™ˆ', 'å°è¤š', 'å°å«', 'å°è’‹', 'å°æ²ˆ', 'å°éŸ©'];
            
            const numComments = Math.floor(Math.random() * 5) + 3; // 3-7æ¡è¯„è®º
            const result = [];
            
            for (let i = 0; i < numComments; i++) {
                // éšæœºé€‰æ‹©è¯„è®ºç±»å‹ï¼Œæ­£é¢è¯„è®ºæ¦‚ç‡æ›´é«˜
                let commentPool;
                const random = Math.random();
                if (random < 0.6) {
                    commentPool = positiveComments; // 60% æ­£é¢è¯„è®º
                } else if (random < 0.8) {
                    commentPool = neutralComments;  // 20% ä¸­æ€§è¯„è®º
                } else {
                    commentPool = negativeComments; // 20% è´Ÿé¢è¯„è®º
                }
                
                const selectedComment = commentPool[Math.floor(Math.random() * commentPool.length)];
                
                result.push({
                    author: authors[Math.floor(Math.random() * authors.length)],
                    rating: selectedComment.rating,
                    text: selectedComment.text,
                    date: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toLocaleDateString()
                });
            }
            
            return result;
        }

        // è®¡ç®—èœå“å¹³å‡è¯„åˆ†
        function calculateDishRating(comments) {
            if (!comments || comments.length === 0) return 3.0;
            const totalRating = comments.reduce((sum, comment) => sum + comment.rating, 0);
            return (totalRating / comments.length).toFixed(1);
        }

        // è®¡ç®—æ‘Šä½å¹³å‡è¯„åˆ†
        function calculateStallRating(dishes) {
            if (!dishes || dishes.length === 0) return 3.0;
            const totalRating = dishes.reduce((sum, dish) => sum + parseFloat(dish.rating), 0);
            return (totalRating / dishes.length).toFixed(1);
        }

        // æ ¹æ®è¯„åˆ†è·å–CSSç±»å
        function getRatingClass(rating) {
            const score = parseFloat(rating);
            if (score >= 4.0) {
                return 'high'; // ç»¿è‰² - 4åˆ†ä»¥ä¸Š
            } else if (score >= 3.0) {
                return 'medium'; // é»„è‰² - 3åˆ°4åˆ†
            } else {
                return 'low'; // çº¢è‰² - 3åˆ†ä»¥ä¸‹
            }
        }

        // ç”Ÿæˆèœå“æ•°æ®
        function generateDishes() {
            const dishes = [];
            for (let i = 1; i <= 4; i++) {
                const comments = generateRandomComments();
                dishes.push({
                    name: `èœå“${i}`,
                    price: Math.floor(Math.random() * 20) + 5, // 5-24å…ƒéšæœºä»·æ ¼
                    rating: calculateDishRating(comments),
                    spicy: getRandomSpicy(),
                    attributes: getRandomAttributes(),
                    comments: comments
                });
            }
            return dishes;
        }

        // ç”Ÿæˆæ‘Šä½æ•°æ®
        function generateStalls() {
            const stalls = [];
            for (let i = 1; i <= 5; i++) {
                const dishes = generateDishes();
                stalls.push({
                    name: `æ‘Šä½${i}`,
                    rating: calculateStallRating(dishes),
                    dishes: dishes,
                    comments: generateRandomComments(),
                    collapsed: true  // é»˜è®¤å…¨éƒ¨æŠ˜å 
                });
            }
            return stalls;
        }

        // ç”Ÿæˆé¤é¥®å¤§æ¥¼æ•°æ®
        function generateCanteens() {
            const canteens = [];
            for (let i = 1; i <= 7; i++) {
                if (i === 1) {
                    // ç¬¬ä¸€é¤é¥®å¤§æ¥¼ä½¿ç”¨çœŸå®æ•°æ®
                    canteens.push({
                        name: `ç¬¬${i}é¤é¥®å¤§æ¥¼`,
                        stalls: generateFirstCanteenStalls(),
                        collapsed: true
                    });
                } else if (i === 2) {
                    // ç¬¬äºŒé¤é¥®å¤§æ¥¼ä½¿ç”¨çœŸå®æ•°æ®
                    canteens.push({
                        name: `ç¬¬${i}é¤é¥®å¤§æ¥¼`,
                        stalls: generateSecondCanteenStalls(),
                        collapsed: true
                    });
                } else {
                    // å…¶ä»–é¤é¥®å¤§æ¥¼ä½¿ç”¨éšæœºæ•°æ®
                    canteens.push({
                        name: `ç¬¬${i}é¤é¥®å¤§æ¥¼`,
                        stalls: generateStalls(),
                        collapsed: true
                    });
                }
            }
            return canteens;
        }

        // ç”Ÿæˆç¬¬ä¸€é¤é¥®å¤§æ¥¼çš„èœå“æ•°æ®ï¼ˆå¸¦è¯„è®ºå’Œè¯„åˆ†è®¡ç®—ï¼‰
        function generateFirstCanteenDish(name, price, spicy, attributes) {
            const comments = generateRandomComments();
            return {
                name: name,
                price: price,
                rating: calculateDishRating(comments),
                spicy: spicy,
                attributes: attributes,
                comments: comments
            };
        }

        // ç”Ÿæˆç¬¬ä¸€é¤é¥®å¤§æ¥¼çš„æ‘Šä½æ•°æ®
        function generateFirstCanteenStalls() {
            const stalls = [];
            
            // æ‘Šä½1ï¼š1-1-1
            const stall1Dishes = [
                generateFirstCanteenDish('ç‰›è‚‰ç²‰ä¸æ±¤', 15, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç‰›æ‚ç²‰ä¸æ±¤', 15, 'ä¸è¾£', ['é«˜è›‹ç™½', 'å’¸é²œå£']),
                generateFirstCanteenDish('é¦™é…¥è„†é¥¼', 2, 'ä¸è¾£', ['ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('è‘±æ²¹é¥¼', 2, 'ä¸è¾£', ['ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç‰›è‚‰ç²‰ä¸é¥¼', 3, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£'])
            ];
            
            stalls.push({
                name: '1-1-1',
                rating: calculateStallRating(stall1Dishes),
                dishes: stall1Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½2ï¼š1-1-2
            const stall2Dishes = [
                generateFirstCanteenDish('é¦™æ‹ŒåœŸè±†ç²‰é¦™æ‹ŒäºŒæº', 16, 'ä¸è¾£', ['ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('æ‹›ç‰Œé†‡é¦™åœŸè±†ç²‰', 16, 'å¾®è¾£', ['ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç»å…¸éº»è¾£åœŸè±†ç²‰', 16, 'å¾®è¾£', ['ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç•ªèŒ„åœŸè±†ç²‰', 16, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('ç‰¹è‰²éº»é…±åœŸè±†ç²‰', 17, 'å¾®è¾£', ['ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç™¾é¦™æœé…¸æ±¤åœŸè±†ç²‰', 18, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('ç”Ÿçƒ«ç‰›è‚‰åœŸè±†ç²‰', 19, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£'])
            ];
            
            stalls.push({
                name: '1-1-2',
                rating: calculateStallRating(stall2Dishes),
                dishes: stall2Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½3ï¼š1-1-3
            const stall3Dishes = [
                generateFirstCanteenDish('é›ªèœè‚‰ä¸é¢', 10, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç¬‹å°–è‚‰æœ«é¢', 10, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç•ªèŒ„é¸¡è›‹é¢', 10, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('è‚‰æœ«é¢', 12, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç‚¸é…±é¢', 12, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('è¾£å­é¸¡é¢', 12, 'å¾®è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('å¤è‚‰é¢', 12, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('é±¼é¦™è‚‰ä¸é¢', 12, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('é¦™è¾£ç‰›è‚‰é¢', 16, 'å¾®è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£'])
            ];
            
            stalls.push({
                name: '1-1-3',
                rating: calculateStallRating(stall3Dishes),
                dishes: stall3Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½4ï¼š1-1-4
            const stall4Dishes = [
                generateFirstCanteenDish('é±¼é¦™è‚‰ä¸å¥—é¤é¥­', 13, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('é’æ¤’è‚‰ä¸å¥—é¤é¥­', 13, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç›ç„—é¸¡è…¿å¥—é¤é¥­', 13, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('é…¸è¾£é¸¡æ‚å¥—é¤é¥­', 13, 'å¾®è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('å¥¥å°”è‰¯è…¿æ’å¥—é¤é¥­', 13, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('å°ç‚’è‚‰å¥—é¤é¥­', 14, 'å¾®è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('è¾£å­é¸¡å¥—é¤é¥­', 14, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('å’•å’¾è‚‰å¥—é¤é¥­', 14, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('é¸¡è›‹è‚‰æœ«å¥—é¤é¥­', 14, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('æ¤’ç›å°é…¥è‚‰å¥—é¤é¥­', 15, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('é¦™é…¥é¸¡æ’å¥—é¤é¥­', 15, 'ä¸è¾£', ['é«˜è›‹ç™½', 'é«˜è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('çº¢çƒ§è‚‰å¥—é¤é¥­', 15, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£'])
            ];
            
            stalls.push({
                name: '1-1-4',
                rating: calculateStallRating(stall4Dishes),
                dishes: stall4Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½5ï¼š1-1-5
            const stall5Dishes = [
                generateFirstCanteenDish('æ²™èŒ¶ç‰›è‚‰ç‚’é¥­', 15, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('æ‰¬å·ç‚’é¥­', 10, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('å¹¿å¼è…Šè‚ ç‚’é¥­', 14, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('éŸ©å¼æ³¡èœäº”èŠ±è‚‰ç‚’é¥­', 16, 'å¾®è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('æ©„æ¦„èœè™¾ä»ç‚’é¥­', 14, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç‰›è‚‰ç‚’é¢', 16, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç‰›è‚‰ç‚’æ²³ç²‰', 15, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£'])
            ];
            
            stalls.push({
                name: '1-1-5',
                rating: calculateStallRating(stall5Dishes),
                dishes: stall5Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½6ï¼š1-1-6
            const stall6Dishes = [
                generateFirstCanteenDish('å°åº¦å’–å–±é¸¡é¥­', 16, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('å°åº¦å’–å–±ç‰›è‚‰é¥­', 19, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('å°åº¦å’–å–±é¸¡è›‹é¥­', 15, 'ä¸è¾£', ['é«˜è›‹ç™½', 'é«˜è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç‰›æ²¹é£é¥¼', 13, 'ä¸è¾£', ['é«˜è›‹ç™½', 'é«˜è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('è‘±èŠ±é£é¥¼', 13, 'ä¸è¾£', ['é«˜è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('èŠéº»é£é¥¼', 12, 'ä¸è¾£', ['ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç«è…¿é£é¥¼', 15, 'ä¸è¾£', ['é«˜è›‹ç™½', 'é«˜è„‚', 'å’¸é²œå£'])
            ];
            
            stalls.push({
                name: '1-1-6',
                rating: calculateStallRating(stall6Dishes),
                dishes: stall6Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½7ï¼š1-1-7
            const stall7Dishes = [
                generateFirstCanteenDish('æœ¨ç“œå…»é¢œç²¥', 5, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('è‘¡è„ç‡•éº¦ç²¥', 4, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('å°ç±³å—ç“œç²¥', 4, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('æ¤°å¥¶è¥¿ç±³éœ²', 5, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('é…’é…¿å°ä¸¸å­', 5, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('çº¢æ£é“¶è€³æ±¤', 4, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£'])
            ];
            
            stalls.push({
                name: '1-1-7',
                rating: calculateStallRating(stall7Dishes),
                dishes: stall7Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½8ï¼š1-1-21
            const stall8Dishes = [
                generateFirstCanteenDish('é¦’å¤´', 0.5, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('çƒ§å–', 1.5, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('çº¢æ£ç³•', 2, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('é¦™è‡å°ç¬¼åŒ…', 5, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('çº¢ç³–ç±³ç³•', 2.5, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('å…¬å©†é¥¼', 3.5, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç´«èœå·', 2.5, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç™½ç³–æ–¹ç³•', 2.5, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£'])
            ];
            
            stalls.push({
                name: '1-1-21',
                rating: calculateStallRating(stall8Dishes),
                dishes: stall8Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½9ï¼š1-1-22
            const stall9Dishes = [
                generateFirstCanteenDish('éª¨æ±¤è¿‡æ¡¥ç±³çº¿ï¼ˆç²—ç²‰ï¼‰', 11, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('éª¨æ±¤è¿‡æ¡¥ç±³çº¿ï¼ˆç»†ç²‰ï¼‰', 11, 'å¾®è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('åœŸé¸¡è¿‡æ¡¥ç±³çº¿ï¼ˆç²—ç²‰ï¼‰', 14, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('åœŸé¸¡è¿‡æ¡¥ç±³çº¿ï¼ˆç»†ç²‰ï¼‰', 14, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£'])
            ];
            
            stalls.push({
                name: '1-1-22',
                rating: calculateStallRating(stall9Dishes),
                dishes: stall9Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½10ï¼š1-1-26
            const stall10Dishes = [
                generateFirstCanteenDish('é…¸æ±¤ç‰›è‚‰æ°´é¥º', 12, 'å¾®è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('biangbiangé¢', 22, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('æ²¹æ³¼é¢', 12, 'ä¸è¾£', ['é«˜è›‹ç™½', 'é«˜è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç‚¸é…±é¢', 11, 'ä¸è¾£', ['é«˜è›‹ç™½', 'é«˜è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('è‚‰å¤¹é¦', 8, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('å²å±±è‡Šå­é¢', 12, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£'])
            ];
            
            stalls.push({
                name: '1-1-26',
                rating: calculateStallRating(stall10Dishes),
                dishes: stall10Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½11ï¼š1-1-27
            const stall11Dishes = [
                generateFirstCanteenDish('éº»è¾£é¸¡ä¸è’¸é¢', 12, 'å¾®è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('é’æ¤’è‚‰ä¸è’¸é¢', 14, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('å¤è‚‰è’¸é¢', 14, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('é¦™è¾£ç‰›è‚‰è’¸é¢', 18, 'å¾®è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£'])
            ];
            
            stalls.push({
                name: '1-1-27',
                rating: calculateStallRating(stall11Dishes),
                dishes: stall11Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½12ï¼š1-1-29
            const stall12Dishes = [
                generateFirstCanteenDish('æ‰‹æŠ“é¥¼', 5, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('é…±é¦™é¥¼', 2.5, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç‰›è‚‰é¦…é¥¼', 3.5, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('çƒ¤çº¢è–¯', 8, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('å…«å®ç²¥', 2.5, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£'])
            ];
            
            stalls.push({
                name: '1-1-29',
                rating: calculateStallRating(stall12Dishes),
                dishes: stall12Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½13ï¼š1-1-30
            const stall13Dishes = [
                generateFirstCanteenDish('å°ç±³ç²¥', 2, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('ç™½ç²¥', 0.5, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('èœç²¥', 2, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('èŒ¶å¶è›‹', 1, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç™½ç…®è›‹', 0.7, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ä¸‰é²œå¤§åŒ…', 1.5, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('é²œè‚‰å¤§åŒ…', 1.5, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('å¥¶é¦™ç‰ç±³åŒ…', 2, 'ä¸è¾£', ['ä½è„‚', 'ç”œå£']),
                generateFirstCanteenDish('èŠ±å·', 1, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£'])
            ];
            
            stalls.push({
                name: '1-1-30',
                rating: calculateStallRating(stall13Dishes),
                dishes: stall13Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½14ï¼š1-1-31
            const stall14Dishes = [
                generateFirstCanteenDish('ç‰›è‚‰æ±¤æ³¡é¥¼ä¸', 16, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç¾Šæ‚æ±¤æ³¡é¥¼ä¸', 16, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£'])
            ];
            
            stalls.push({
                name: '1-1-31',
                rating: calculateStallRating(stall14Dishes),
                dishes: stall14Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½15ï¼š1-1-32
            const stall15Dishes = [
                generateFirstCanteenDish('è‘±æ²¹æ‹Œé¢', 6, 'ä¸è¾£', ['é«˜è›‹ç™½', 'é«˜è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('é»„ç„–é¸¡é¢ï¼ˆç²‰ï¼‰', 12, 'ä¸è¾£', ['é«˜è›‹ç™½', 'é«˜è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('é…¸è¾£é¸¡ä¸é¢ï¼ˆç²‰ï¼‰', 12, 'å¾®è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ä»€é”¦é±¼ä¸¸é¢ï¼ˆç²‰ï¼‰', 12, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('çº¢çƒ§ç‰›è‚‰é¢ï¼ˆç²‰ï¼‰', 16, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£'])
            ];
            
            stalls.push({
                name: '1-1-32',
                rating: calculateStallRating(stall15Dishes),
                dishes: stall15Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½16ï¼š1-1-34
            const stall16Dishes = [
                generateFirstCanteenDish('é»‘æ¤’é¸¡æŸ³é¥­', 13, 'å¾®è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('é±¼é¦™è‚‰ä¸é¥­', 13, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('æ¤°æ±å’–å–±é¸¡é¥­', 13, 'ä¸è¾£', ['é«˜è›‹ç™½', 'é«˜è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç•ªèŒ„ç‰›è‚‰æ»‘è›‹é¥­', 15, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£'])
            ];
            
            stalls.push({
                name: '1-1-34',
                rating: calculateStallRating(stall16Dishes),
                dishes: stall16Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½17ï¼š1-2-1
            const stall17Dishes = [
                generateFirstCanteenDish('çŒªè„šé¥­', 16, 'ä¸è¾£', ['é«˜è›‹ç™½', 'é«˜è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('å·é¦™ç‰›è‚‰é¥­', 18, 'å¾®è¾£', ['é«˜è›‹ç™½', 'é«˜è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('é…±é¦™æ’éª¨é¥­', 16, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'ç”œå£'])
            ];
            
            stalls.push({
                name: '1-2-1',
                rating: calculateStallRating(stall17Dishes),
                dishes: stall17Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½18ï¼š1-2-2
            const stall18Dishes = [
                generateFirstCanteenDish('é¦™è¾£çƒ¤å…¨é±¼é¥­', 22, 'å¾®è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('è’œé¦™çƒ¤å…¨é±¼é¥­', 22, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£']),
                generateFirstCanteenDish('ç•ªèŒ„çƒ¤å…¨é±¼é¥­', 22, 'ä¸è¾£', ['é«˜è›‹ç™½', 'ä½è„‚', 'å’¸é²œå£'])
            ];
            
            stalls.push({
                name: '1-2-2',
                rating: calculateStallRating(stall18Dishes),
                dishes: stall18Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });
            
            return stalls;
        }

        // ç”Ÿæˆç¬¬äºŒé¤é¥®å¤§æ¥¼çš„èœå“æ•°æ®ï¼ˆå¸¦è¯„è®ºå’Œè¯„åˆ†è®¡ç®—ï¼‰
        function generateSecondCanteenDish(name, price, spiceLevel, rating, oilLevel, sweetSalty, protein) {
            const comments = generateRandomComments();
            
            // è½¬æ¢æ•°æ®æ ¼å¼
            let spicy = 'ä¸è¾£';
            if (spiceLevel === 1) {
                spicy = 'å¾®è¾£';
            }
            
            let attributes = [];
            if (oilLevel === 1) {
                attributes.push('é«˜è„‚');
            } else {
                attributes.push('ä½è„‚');
            }
            
            if (sweetSalty === 1) {
                attributes.push('å’¸é²œå£');
            } else {
                attributes.push('ç”œå£');
            }
            
            if (protein === 1) {
                attributes.push('é«˜è›‹ç™½');
            }
            
            return {
                name: name,
                price: price,
                rating: rating ? rating.toString() : calculateDishRating(comments),
                spicy: spicy,
                attributes: attributes,
                comments: comments
            };
        }

        // ç”Ÿæˆç¬¬äºŒé¤é¥®å¤§æ¥¼çš„æ‘Šä½æ•°æ®
        function generateSecondCanteenStalls() {
            const stalls = [];
            
            // æ‘Šä½1ï¼š2-1-1 é¦„é¥¨ç±»
            const stall1Dishes = [
                generateSecondCanteenDish('è™¾ä»è™¾æ»‘é¦„é¥¨', 25, 0, null, 0, 1, 1),
                generateSecondCanteenDish('ç•ªèŒ„ç‰›è‚‰é¦„é¥¨', 20, 0, null, 0, 1, 1),
                generateSecondCanteenDish('è™¾ä»é²œè‚‰é¦„é¥¨', 19, 0, null, 0, 1, 1),
                generateSecondCanteenDish('å®¶ä¹¡è…Šè‚‰é¦„é¥¨', 21, 0, null, 0, 1, 1),
                generateSecondCanteenDish('çº¢æ²¹æŠ„æ‰‹', 18, 1, null, 1, 1, 1),
                generateSecondCanteenDish('è’œè“‰èŠ±ç”Ÿé…±æ‹Œé¦„é¥¨', 18, 1, null, 0, 1, 1),
                generateSecondCanteenDish('å…¨å®¶ç¦é¦„é¥¨', 17, 0, null, 0, 1, 1),
                generateSecondCanteenDish('ç‰ç±³é²œè‚‰é¦„é¥¨', 15, 0, null, 0, 1, 1),
                generateSecondCanteenDish('è èœé²œè‚‰é¦„é¥¨', 14, 0, null, 0, 1, 1),
                generateSecondCanteenDish('èŠ¹èœé²œè‚‰é¦„é¥¨', 12, 0, null, 0, 1, 1),
                generateSecondCanteenDish('é¸¡æ±¤å°é¦„é¥¨', 6, 0, null, 0, 1, 0),
                generateSecondCanteenDish('è™¾ä»å°é¦„é¥¨', 15, 0, null, 0, 1, 1)
            ];
            
            stalls.push({
                name: '2-1-1',
                rating: calculateStallRating(stall1Dishes),
                dishes: stall1Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½2ï¼š2-1-2 æ°´é¥ºç±»
            const stall2Dishes = [
                generateSecondCanteenDish('éŸ­èœé¸¡è›‹æ°´é¥º', 10, 0, null, 0, 1, 0),
                generateSecondCanteenDish('èŠ¹èœé¸¡è›‹æ°´é¥º', 10, 0, null, 0, 1, 0),
                generateSecondCanteenDish('è èœé¸¡è›‹æ°´é¥º', 10, 0, null, 0, 1, 0),
                generateSecondCanteenDish('ç™½èœé¸¡è›‹æ°´é¥º', 10, 0, null, 0, 1, 0),
                generateSecondCanteenDish('çŒªè‚‰å¤§è‘±æ°´é¥º', 10, 0, null, 0, 1, 0),
                generateSecondCanteenDish('è²è—•é²œè‚‰æ°´é¥º', 10, 0, null, 0, 1, 0)
            ];
            
            stalls.push({
                name: '2-1-2',
                rating: calculateStallRating(stall2Dishes),
                dishes: stall2Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½3ï¼š2-1-3 çŸ³é”…ç±»
            const stall3Dishes = [
                generateSecondCanteenDish('çˆ†æ±çŸ³é”…é¸¡', 15, 1, null, 1, 1, 0),
                generateSecondCanteenDish('çŸ³é”…æ’éª¨', 18, 1, null, 1, 1, 1),
                generateSecondCanteenDish('çŸ³é”…ç‰›è…©', 18, 1, null, 1, 1, 1),
                generateSecondCanteenDish('çŸ³é”…ä¸‰æ ·', 13, 1, null, 1, 1, 0),
                generateSecondCanteenDish('çŸ³é”…é¦™è‚ ', 13, 1, null, 1, 1, 0),
                generateSecondCanteenDish('çŸ³é”…é±¼ç‰‡', 15, 1, null, 1, 1, 1),
                generateSecondCanteenDish('æ‹›ç‰Œé±¼ç²‰', 14, 1, null, 0, 1, 1),
                generateSecondCanteenDish('åŸå‘³é±¼ç²‰', 14, 1, null, 0, 1, 1),
                generateSecondCanteenDish('ç•ªèŒ„äº”è°·é±¼ç²‰', 14, 1, null, 0, 1, 1)
            ];
            
            stalls.push({
                name: '2-1-3',
                rating: calculateStallRating(stall3Dishes),
                dishes: stall3Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½8ï¼š2-1-8 å·èœç±»
            const stall8Dishes = [
                generateSecondCanteenDish('é‡åº†é¸¡å…¬ç…²', 16, 1, 3.2, 1, 1, 1),
                generateSecondCanteenDish('é‡åº†æ¯›è¡€æ—º', 16, 1, 4.5, 1, 1, 1),
                generateSecondCanteenDish('æ°´ç…®è‚‰ç‰‡', 15, 1, 3.8, 1, 1, 1),
                generateSecondCanteenDish('æ°´ç…®é’µé’µé±¼', 15, 1, 4.1, 1, 1, 1),
                generateSecondCanteenDish('çœ‰å±±é…¸èœé±¼', 15, 1, 3.5, 1, 1, 1),
                generateSecondCanteenDish('é…¸æ±¤è‚¥ç‰›', 15, 1, 4.7, 1, 1, 1),
                generateSecondCanteenDish('ç•ªèŒ„é’µé’µé±¼', 16, 0, 3.1, 0, 0, 1),
                generateSecondCanteenDish('ç•ªèŒ„è‚¥ç‰›', 15, 0, 4.3, 1, 0, 1)
            ];
            
            stalls.push({
                name: '2-1-8',
                rating: calculateStallRating(stall8Dishes),
                dishes: stall8Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½9ï¼š2-1-9 ç²‰é¢ç±»
            const stall9Dishes = [
                generateSecondCanteenDish('é‡åº†ç‰›è‚‰é…¸è¾£ç²‰', 14, 1, 3.9, 0, 1, 1),
                generateSecondCanteenDish('é‡åº†è‚¥è‚ é…¸è¾£ç²‰', 13, 1, 4.0, 1, 1, 1),
                generateSecondCanteenDish('é¸­è¡€ç²‰ä¸æ±¤', 12, 0, 3.4, 0, 1, 0)
            ];
            
            stalls.push({
                name: '2-1-9',
                rating: calculateStallRating(stall9Dishes),
                dishes: stall9Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½10ï¼š2-1-10 å’–å–±ç±»
            const stall10Dishes = [
                generateSecondCanteenDish('é¦™è¾£é¸¡æ’å’–å–±é¥­', 15, 1, 4.6, 1, 1, 1),
                generateSecondCanteenDish('ä»€é”¦è”¬èœå’–å–±é¥­', 10, 0, 3.7, 0, 1, 0),
                generateSecondCanteenDish('é›ªèŠ±é¸¡æŸ³å’–å–±é¥­', 15, 0, 4.2, 1, 1, 1),
                generateSecondCanteenDish('å°é…¥è‚‰å’–å–±é¥­', 16, 0, 3.3, 1, 1, 1),
                generateSecondCanteenDish('ç…è›‹è”¬èœå’–å–±é¥­', 13, 0, 4.8, 0, 1, 1),
                generateSecondCanteenDish('å‰å‰è„†è½¯éª¨å’–å–±é¥­', 16, 0, 3.6, 1, 1, 0),
                generateSecondCanteenDish('è´è¶ç¿…æ’å’–å–±é¥­', 17, 0, 4.4, 1, 1, 1),
                generateSecondCanteenDish('æ—¶è”¬å’–å–±è›‹åŒ…é¥­', 14, 0, 3.0, 0, 1, 0),
                generateSecondCanteenDish('è„†éª¨è‚ å’–å–±é¥­', 16, 0, 4.9, 0, 1, 1),
                generateSecondCanteenDish('ç«¹èšé±¼æ’å’–å–±é¥­', 16, 0, 4.2, 1, 1, 1),
                generateSecondCanteenDish('åšçƒ§é¸¡è‚‰å’–å–±é¥­', 16, 0, 3.2, 1, 1, 1),
                generateSecondCanteenDish('é¸¡ç±³èŠ±å’–å–±é¥­', 16, 0, 4.5, 1, 1, 1)
            ];
            
            stalls.push({
                name: '2-1-10',
                rating: calculateStallRating(stall10Dishes),
                dishes: stall10Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½11ï¼š2-1-11 ç²¥ç±»
            const stall11Dishes = [
                generateSecondCanteenDish('è¥¿ç“œä¸¸å­æ²™', 5, 0, 3.8, 0, 0, 0),
                generateSecondCanteenDish('æœ¨ç“œå…»é¢œç²¥', 5, 0, 4.1, 0, 0, 0),
                generateSecondCanteenDish('çº¢è±†è–ä»ç²¥', 4, 0, 3.5, 0, 0, 0),
                generateSecondCanteenDish('ç‡•éº¦è‘¡è„ç²¥', 4, 0, 4.7, 0, 0, 0),
                generateSecondCanteenDish('å°ç±³å—ç“œç²¥', 4, 0, 3.1, 0, 0, 0),
                generateSecondCanteenDish('çš®è›‹é’èœç²¥', 4, 0, 4.3, 0, 1, 0),
                generateSecondCanteenDish('çº¢ç³–è—•ç²‰ç²¥', 5, 0, 3.9, 0, 0, 0)
            ];
            
            stalls.push({
                name: '2-1-11',
                rating: calculateStallRating(stall11Dishes),
                dishes: stall11Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½13ï¼š2-1-13 å¹²é”…ç±»
            const stall13Dishes = [
                generateSecondCanteenDish('å¹²é”…æ’éª¨', 16, 0, 4.1, 1, 1, 1),
                generateSecondCanteenDish('å¹²é”…é…¥è‚‰', 15, 0, 3.8, 1, 1, 1),
                generateSecondCanteenDish('å¹²é”…é¸¡å—', 15, 0, 4.0, 1, 1, 1),
                generateSecondCanteenDish('å†œå®¶å°ç‚’è‚‰', 15, 0, 3.5, 1, 1, 1),
                generateSecondCanteenDish('æ­Œä¹å±±è¾£å­é¸¡', 15, 1, 3.1, 1, 1, 1),
                generateSecondCanteenDish('é±¼é¦™è‚‰ä¸', 14, 0, 4.2, 0, 1, 1),
                generateSecondCanteenDish('é…±æ±æ’éª¨å•«å•«ç…²', 16, 0, 3.9, 0, 1, 1),
                generateSecondCanteenDish('é¦™æ±è‚¥ç‰›å•«å•«ç…²', 16, 0, 4.3, 0, 1, 1),
                generateSecondCanteenDish('å·é¦™æ¤’éº»é¸¡å•«å•«ç…²', 15, 1, 3.5, 1, 1, 1),
                generateSecondCanteenDish('é‡åº†é¸¡å…¬ç…²', 16, 1, 3.7, 1, 1, 1),
                generateSecondCanteenDish('é‡åº†æ¯›è¡€æ—º', 16, 1, 3.1, 1, 1, 1),
                generateSecondCanteenDish('æ°´ç…®è‚‰ç‰‡', 15, 0, 4.6, 0, 0, 1),
                generateSecondCanteenDish('æ°´ç…®é’µé’µé±¼', 15, 0, 4.8, 0, 0, 1),
                generateSecondCanteenDish('çœ‰å±±é…¸èœé±¼', 15, 0, 4.2, 1, 0, 1),
                generateSecondCanteenDish('é…¸æ±¤è‚¥ç‰›', 15, 0, 3.9, 0, 0, 1),
                generateSecondCanteenDish('ç•ªèŒ„é’µé’µé±¼', 15, 0, 4.6, 0, 0, 1),
                generateSecondCanteenDish('ç•ªèŒ„è‚¥ç‰›', 15, 0, 3.8, 0, 0, 1)
            ];
            
            stalls.push({
                name: '2-1-13',
                rating: calculateStallRating(stall13Dishes),
                dishes: stall13Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });

            // æ‘Šä½14ï¼š2-1-14 è¥¿é¤ç±»
            const stall14Dishes = [
                generateSecondCanteenDish('è‚‰é…±åœŸè±†æ³¥æé¥­', 9, 0, 3.1, 0, 1, 1),
                generateSecondCanteenDish('è‚‰é…±åœŸè±†æ³¥è¾£è±†è…æé¥­', 11, 1, 4.3, 0, 1, 1),
                generateSecondCanteenDish('è‚‰é…±åœŸè±†æ³¥ä¸‰æ¯é¸¡æé¥­', 15, 0, 3.6, 0, 1, 1),
                generateSecondCanteenDish('è‚‰é…±åœŸè±†æ³¥æ¸¯å¼é¸­è‚‰æé¥­', 15, 0, 3.5, 0, 1, 1),
                generateSecondCanteenDish('è‚‰é…±åœŸè±†æ³¥æ— éª¨æ²¹é¸¡æé¥­', 16, 0, 4.2, 1, 1, 1),
                generateSecondCanteenDish('è‚‰é…±åœŸè±†æ³¥æ„å¼çƒ¤é¸¡è‚‰é¥­', 15, 0, 3.1, 0, 1, 1),
                generateSecondCanteenDish('è‚‰é…±åœŸè±†æ³¥å·´è¥¿äº”èŠ±è‚‰é¥­', 18, 0, 3.2, 0, 1, 1),
                generateSecondCanteenDish('è²åŠ›ç‰›æ’é¥­/æ„é¢', 48, 0, 4.3, 0, 1, 1),
                generateSecondCanteenDish('è¥¿å†·ç‰›æ’é¥­/æ„é¢', 42, 0, 3.4, 0, 1, 1),
                generateSecondCanteenDish('ä¸éª¨ç‰›æ’é¥­/æ„é¢', 42, 0, 3.3, 0, 1, 1),
                generateSecondCanteenDish('ç²¾å“ç‰›æ’é¥­/æ„é¢', 25, 0, 3.5, 0, 1, 1),
                generateSecondCanteenDish('å…ƒæ°”çŒªæ’é¥­/æ„é¢', 19, 0, 3.7, 0, 1, 1),
                generateSecondCanteenDish('é»‘æ¤’è‚‰æ’é¥­/æ„é¢', 19, 0, 4.7, 0, 1, 1),
                generateSecondCanteenDish('é¦™ç…é±¼æ’é¥­/æ„é¢', 19, 0, 3.6, 1, 1, 1),
                generateSecondCanteenDish('å«©çƒ¤é¸¡æ’é¥­/æ„é¢', 19, 0, 3.5, 0, 1, 1),
                generateSecondCanteenDish('é¦™é…¥é¸¡è…¿é¥­/æ„é¢', 15, 0, 4.7, 1, 1, 1),
                generateSecondCanteenDish('é»‘æ¤’è‚‰æŸ³é¥­/æ„é¢', 15, 0, 4.6, 0, 1, 1),
                generateSecondCanteenDish('æ—¥å¼è‚¥ç‰›é¥­/æ„é¢', 18, 0, 3.9, 0, 1, 1),
                generateSecondCanteenDish('æ„å¤§åˆ©è‚‰é…±é¢', 15, 0, 3.6, 0, 1, 1),
                generateSecondCanteenDish('è˜‘è‡å¥¶æ²¹åŸ¹æ ¹é¢', 15, 0, 4.3, 1, 0, 0),
                generateSecondCanteenDish('æ„å¼è‡Šå­è‚‰é¢', 13, 0, 4.4, 0, 1, 1),
                generateSecondCanteenDish('èŒ„æ±é‡‘æªé±¼æ„é¢', 18, 0, 3.6, 0, 1, 1)
            ];
            
            stalls.push({
                name: '2-1-14',
                rating: calculateStallRating(stall14Dishes),
                dishes: stall14Dishes,
                comments: generateRandomComments(),
                collapsed: true
            });
            
            return stalls;
        }

        // æ¸²æŸ“é¤é¥®å¤§æ¥¼
        function renderCanteens(canteens) {
            const grid = document.getElementById('canteenGrid');
            grid.innerHTML = '';

            canteens.forEach(canteen => {
                const canteenCard = document.createElement('div');
                canteenCard.className = 'canteen-card';
                canteenCard.innerHTML = `
                    <div class="canteen-header" onclick="toggleCanteen('${canteen.name}')">
                        <div class="canteen-title">${canteen.name}</div>
                        <button class="canteen-toggle-btn">${canteen.collapsed ? 'å±•å¼€' : 'æŠ˜å '}</button>
                    </div>
                    <div class="stalls-container ${canteen.collapsed ? 'collapsed' : ''}">
                        <div class="stalls-grid">
                            ${canteen.stalls.map((stall, stallIndex) => `
                                <div class="stall">
                                    <div class="stall-header" onclick="toggleStall('${canteen.name}', '${stall.name}')">
                                        <div class="stall-name">${stall.name}</div>
                                        <div style="display: flex; align-items: center;">
                                            <div class="stall-rating ${getRatingClass(stall.rating)}">${stall.rating}â­</div>
                                            <button class="toggle-btn">${stall.collapsed ? 'å±•å¼€' : 'æŠ˜å '}</button>
                                        </div>
                                    </div>
                                    <div class="dishes ${stall.collapsed ? 'collapsed' : ''}">
                                        ${stall.dishes.map((dish, dishIndex) => `
                                            <div class="dish" onclick="showComments('${canteen.name}', '${stall.name}', ${dishIndex}, 'dish')">
                                                <div class="dish-name">${dish.name}</div>
                                                <div class="dish-price">Â¥${dish.price}</div>
                                                <div class="dish-rating">${dish.rating}â­</div>
                                                <div class="dish-attributes">
                                                    <span class="attribute-tag spicy-tag">${dish.spicy}</span>
                                                    ${dish.attributes.map(attr => `
                                                        <span class="attribute-tag ${attr === 'åŠ è‘±' ? 'onion-tag' : attr === 'é«˜è„‚' ? 'heat-tag' : ''}">${attr}</span>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                grid.appendChild(canteenCard);
            });
        }

        // æœç´¢åŠŸèƒ½ - æ™ºèƒ½åŒ¹é…ç‰ˆ
        function searchCanteens(query) {
            if (!query.trim()) {
                applyAllFilters();
                return;
            }
            
            // éšè—ä¹‹å‰çš„æœç´¢ç»Ÿè®¡
            const searchStats = document.getElementById('searchStats');
            if (searchStats) {
                searchStats.style.display = 'none';
            }

            const searchTerm = query.toLowerCase().trim();
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯é¤é¥®å¤§æ¥¼æœç´¢
            const canteenMatch = searchTerm.match(/ç¬¬([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+)é¤é¥®å¤§æ¥¼/);
            if (canteenMatch) {
                const canteenNumber = canteenMatch[1];
                // å°†ä¸­æ–‡æ•°å­—è½¬æ¢ä¸ºé˜¿æ‹‰ä¼¯æ•°å­—
                const numberMap = {
                    'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5, 
                    'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'å': 10
                };
                const canteenIndex = numberMap[canteenNumber] || parseInt(canteenNumber);
                
                if (canteenIndex && canteenIndex >= 1 && canteenIndex <= 7) {
                    // æ˜¾ç¤ºæŒ‡å®šé¤é¥®å¤§æ¥¼çš„æ‰€æœ‰èœå“
                    const targetCanteen = canteensData.find(c => c.name === `ç¬¬${canteenIndex}é¤é¥®å¤§æ¥¼`);
                    if (targetCanteen) {
                        // å±•å¼€è¯¥é¤é¥®å¤§æ¥¼çš„æ‰€æœ‰æ‘Šä½
                        targetCanteen.collapsed = false;
                        targetCanteen.stalls.forEach(stall => {
                            stall.collapsed = false;
                        });
                        
                        const filteredCanteens = [targetCanteen];
                        renderCanteens(filteredCanteens);
                        updateSearchStats(query, filteredCanteens);
                        return;
                    }
                }
            }
            
            // èœå“åç§°æœç´¢ - æ˜¾ç¤ºæ‰€æœ‰åŒ¹é…çš„èœå“
            const allDishes = [];
            canteensData.forEach(canteen => {
                canteen.stalls.forEach(stall => {
                    stall.dishes.forEach(dish => {
                        if (dish.name.toLowerCase().includes(searchTerm)) {
                            allDishes.push({
                                ...dish,
                                canteenName: canteen.name,
                                stallName: stall.name
                            });
                        }
                    });
                });
            });

            if (allDishes.length > 0) {
                // æ˜¾ç¤ºæ‰€æœ‰åŒ¹é…çš„èœå“
                renderSearchResults(allDishes, query);
                return;
            }

            // å…¶ä»–æœç´¢ï¼ˆè¾£åº¦ã€å±æ€§ã€ä»·æ ¼ç­‰ï¼‰
            const filteredCanteens = canteensData.map(canteen => {
                const currentCanteen = canteensData.find(c => c.name === canteen.name);
                
                const filteredStalls = currentCanteen.stalls.map(stall => {
                    const filteredDishes = stall.dishes.filter(dish => {
                        const searchableText = [
                            dish.spicy,
                            ...dish.attributes,
                            stall.name,
                            currentCanteen.name
                        ].join(' ').toLowerCase();

                        const matchesDish = searchableText.includes(searchTerm) ||
                            dish.price.toString().includes(searchTerm) ||
                            dish.rating.toString().includes(searchTerm);

                        if (!matchesDish) return false;
                        
                        // åº”ç”¨å½“å‰ç­›é€‰æ¡ä»¶
                        if (currentFilters.spicy !== 'all' && dish.spicy !== currentFilters.spicy) {
                            return false;
                        }
                        
                        const dishRating = parseFloat(dish.rating);
                        if (currentFilters.minRating !== null && dishRating < currentFilters.minRating) {
                            return false;
                        }
                        if (currentFilters.maxRating !== null && dishRating > currentFilters.maxRating) {
                            return false;
                        }
                        
                        if (currentFilters.minPrice !== null && dish.price < currentFilters.minPrice) {
                            return false;
                        }
                        if (currentFilters.maxPrice !== null && dish.price > currentFilters.maxPrice) {
                            return false;
                        }
                        
                        return true;
                    });
                    
                    if (filteredDishes.length > 0) {
                        return {
                            name: stall.name,
                            rating: stall.rating,
                            dishes: filteredDishes,
                            comments: stall.comments,
                            collapsed: stall.collapsed
                        };
                    }
                    return null;
                }).filter(stall => stall !== null);

                if (filteredStalls.length > 0) {
                    return currentCanteen;
                }
                return null;
            }).filter(canteen => canteen !== null);

            // åªæœ‰åœ¨æœ‰æœç´¢ç»“æœæ—¶æ‰æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            if (filteredCanteens.length > 0) {
                renderCanteens(filteredCanteens);
                updateSearchStats(query, filteredCanteens);
            } else {
                // æ²¡æœ‰æ‰¾åˆ°ç»“æœæ—¶ï¼Œæ˜¾ç¤ºæ‰€æœ‰å†…å®¹ä½†ä¸æ˜¾ç¤ºå¤±è´¥æç¤º
                applyAllFilters();
            }
        }

        // æ¸²æŸ“æœç´¢ç»“æœï¼ˆèœå“åˆ—è¡¨ï¼‰
        function renderSearchResults(dishes, query) {
            const grid = document.getElementById('canteenGrid');
            grid.innerHTML = '';

            // åˆ›å»ºæœç´¢ç»“æœæ ‡é¢˜
            const resultHeader = document.createElement('div');
            resultHeader.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 15px;
                margin-bottom: 20px;
                text-align: center;
            `;
            resultHeader.innerHTML = `
                <h2>ğŸ” æœç´¢ç»“æœ</h2>
                <p>æ‰¾åˆ° ${dishes.length} é“åŒ…å« "<strong>${query}</strong>" çš„èœå“</p>
                <button onclick="clearSearch()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; margin-top: 10px;">æ¸…é™¤æœç´¢</button>
            `;
            grid.appendChild(resultHeader);

            // åˆ›å»ºèœå“åˆ—è¡¨
            const dishesContainer = document.createElement('div');
            dishesContainer.style.cssText = `
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
            `;

            dishes.forEach((dish, index) => {
                const dishCard = document.createElement('div');
                dishCard.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 20px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                    border-left: 4px solid #3498db;
                    transition: transform 0.3s ease;
                    cursor: pointer;
                `;
                dishCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <h3 style="color: #2c3e50; margin: 0; font-size: 1.2em;">${dish.name}</h3>
                        <span style="background: #f39c12; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.9em; font-weight: bold;">
                            #${index + 1}
                        </span>
                    </div>
                    <div style="color: #e74c3c; font-weight: bold; font-size: 1.1em; margin-bottom: 8px;">Â¥${dish.price}</div>
                    <div style="margin-bottom: 10px;">
                        <span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; margin-right: 5px;">${dish.spicy}</span>
                        ${dish.attributes.map(attr => `
                            <span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; margin-right: 5px;">${attr}</span>
                        `).join('')}
                    </div>
                    <div style="color: #7f8c8d; font-size: 0.9em; margin-bottom: 8px;">
                        ğŸ“ ${dish.canteenName} - ${dish.stallName}
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #f39c12; font-weight: bold;">${dish.rating}â­</span>
                    </div>
                `;
                dishCard.addEventListener('click', () => {
                    // æ‰¾åˆ°å¯¹åº”çš„èœå“å¹¶æ‰“å¼€è¯„è®ºç•Œé¢
                    const targetCanteen = canteensData.find(c => c.name === dish.canteenName);
                    if (targetCanteen) {
                        const targetStall = targetCanteen.stalls.find(s => s.name === dish.stallName);
                        if (targetStall) {
                            const dishIndex = targetStall.dishes.findIndex(d => d.name === dish.name);
                            if (dishIndex !== -1) {
                                // ç›´æ¥æ‰“å¼€è¯„è®ºç•Œé¢
                                showComments(dish.canteenName, dish.stallName, dishIndex, 'dish');
                                return;
                            }
                        }
                    }
                    // å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”èœå“ï¼Œåˆ™å±•å¼€æ‘Šä½
                    const fallbackCanteen = canteensData.find(c => c.name === dish.canteenName);
                    if (fallbackCanteen) {
                        fallbackCanteen.collapsed = false;
                        const fallbackStall = fallbackCanteen.stalls.find(s => s.name === dish.stallName);
                        if (fallbackStall) {
                            fallbackCanteen.stalls.forEach(s => s.collapsed = true);
                            fallbackStall.collapsed = false;
                        }
                    }
                    clearSearch();
                });
                dishesContainer.appendChild(dishCard);
            });

            grid.appendChild(dishesContainer);
        }


        // å…¨å±€ç­›é€‰çŠ¶æ€
        let currentFilters = {
            spicy: 'all',
            minRating: null,
            maxRating: null,
            minPrice: null,
            maxPrice: null
        };

        // æŒ‰è¾£åº¦ç­›é€‰
        function filterBySpicy(spicyLevel) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            currentFilters.spicy = spicyLevel;
            applyAllFilters();
        }

        // æŒ‰è¯„åˆ†ç­›é€‰
        function filterByRating() {
            const minRating = parseFloat(document.getElementById('minRating').value);
            const maxRating = parseFloat(document.getElementById('maxRating').value);
            
            currentFilters.minRating = isNaN(minRating) ? null : minRating;
            currentFilters.maxRating = isNaN(maxRating) ? null : maxRating;
            
            applyAllFilters();
        }

        // æŒ‰ä»·æ ¼ç­›é€‰
        function filterByPrice() {
            const minPrice = parseFloat(document.getElementById('minPrice').value);
            const maxPrice = parseFloat(document.getElementById('maxPrice').value);
            
            currentFilters.minPrice = isNaN(minPrice) ? null : minPrice;
            currentFilters.maxPrice = isNaN(maxPrice) ? null : maxPrice;
            
            applyAllFilters();
        }

        // æ¸…é™¤æ‰€æœ‰ç­›é€‰
        function clearAllFilters() {
            currentFilters = {
                spicy: 'all',
                minRating: null,
                maxRating: null,
                minPrice: null,
                maxPrice: null
            };
            
            // é‡ç½®ç•Œé¢
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.filter-btn[onclick="filterBySpicy(\'all\')"]').classList.add('active');
            document.getElementById('minRating').value = '';
            document.getElementById('maxRating').value = '';
            document.getElementById('minPrice').value = '';
            document.getElementById('maxPrice').value = '';
            
            applyAllFilters();
        }

        // åº”ç”¨æ‰€æœ‰ç­›é€‰æ¡ä»¶
        function applyAllFilters() {
            // åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®ç»“æ„ï¼ŒåŒ…å«ç­›é€‰åçš„ç»“æœ
            const filteredCanteens = canteensData.map(canteen => {
                // è·å–å½“å‰é¤é¥®å¤§æ¥¼
                const currentCanteen = canteensData.find(c => c.name === canteen.name);
                
                // ç­›é€‰æ¯ä¸ªæ‘Šä½ï¼Œåˆ›å»ºæ–°çš„æ‘Šä½å¯¹è±¡ï¼ŒåªåŒ…å«ç¬¦åˆæ¡ä»¶çš„èœå“
                const filteredStalls = currentCanteen.stalls.map(stall => {
                    // ç­›é€‰è¯¥æ‘Šä½ä¸­ç¬¦åˆæ¡ä»¶çš„èœå“
                    const filteredDishes = stall.dishes.filter(dish => {
                        // è¾£åº¦ç­›é€‰
                        if (currentFilters.spicy !== 'all' && dish.spicy !== currentFilters.spicy) {
                            return false;
                        }
                        
                        // è¯„åˆ†ç­›é€‰
                        const dishRating = parseFloat(dish.rating);
                        if (currentFilters.minRating !== null && dishRating < currentFilters.minRating) {
                            return false;
                        }
                        if (currentFilters.maxRating !== null && dishRating > currentFilters.maxRating) {
                            return false;
                        }
                        
                        // ä»·æ ¼ç­›é€‰
                        if (currentFilters.minPrice !== null && dish.price < currentFilters.minPrice) {
                            return false;
                        }
                        if (currentFilters.maxPrice !== null && dish.price > currentFilters.maxPrice) {
                            return false;
                        }
                        
                        // ç˜¦èº«ç­›é€‰ï¼šéšè—é«˜è„‚èœå“
                        if (slimFilterActive && dish.attributes.includes('é«˜è„‚')) {
                            return false;
                        }
                        
                        // å¥èº«ç­›é€‰ï¼šåªæ˜¾ç¤ºé«˜è›‹ç™½èœå“
                        if (fitnessFilterActive && !dish.attributes.includes('é«˜è›‹ç™½')) {
                            return false;
                        }
                        
                        return true;
                    });
                    
                    // å¦‚æœæœ‰ç¬¦åˆæ¡ä»¶çš„èœå“ï¼Œè¿”å›æ–°çš„æ‘Šä½å¯¹è±¡
                    if (filteredDishes.length > 0) {
                        return {
                            name: stall.name,
                            rating: stall.rating,
                            dishes: filteredDishes,
                            comments: stall.comments,
                            collapsed: stall.collapsed  // ä¿æŒåŸå§‹æŠ˜å çŠ¶æ€
                        };
                    }
                    return null;
                }).filter(stall => stall !== null); // è¿‡æ»¤æ‰æ²¡æœ‰èœå“çš„æ‘Šä½

                // å¦‚æœè¯¥é¤é¥®å¤§æ¥¼è¿˜æœ‰æ‘Šä½ï¼Œè¿”å›æ–°çš„é¤é¥®å¤§æ¥¼å¯¹è±¡
                if (filteredStalls.length > 0) {
                    return {
                        name: currentCanteen.name,
                        stalls: filteredStalls,
                        collapsed: currentCanteen.collapsed  // ä¿æŒåŸå§‹æŠ˜å çŠ¶æ€
                    };
                }
                return null;
            }).filter(canteen => canteen !== null); // è¿‡æ»¤æ‰æ²¡æœ‰æ‘Šä½çš„é¤é¥®å¤§æ¥¼

            renderCanteens(filteredCanteens);
        }

        // å…¨å±€å˜é‡
        let canteensData = generateCanteens();
        let currentModalData = null;
        
        // ç­›é€‰ç›¸å…³å˜é‡
        let filterSettings = {
            spicy: null,
            location: null,
            priority: null
        };
        let currentStep = 1;
        
        // ç˜¦èº«å’Œå¥èº«ç­›é€‰çŠ¶æ€
        let slimFilterActive = false;
        let fitnessFilterActive = false;

        // åˆ‡æ¢é¤é¥®å¤§æ¥¼æŠ˜å çŠ¶æ€
        function toggleCanteen(canteenName) {
            const canteen = canteensData.find(c => c.name === canteenName);
            if (canteen) {
                canteen.collapsed = !canteen.collapsed;
                // é‡æ–°åº”ç”¨ç­›é€‰æ¡ä»¶ä»¥æ›´æ–°æ˜¾ç¤º
                applyAllFilters();
            }
        }

        // åˆ‡æ¢æ‘Šä½æŠ˜å çŠ¶æ€ï¼ˆä¿®å¤ç­›é€‰çŠ¶æ€ä¸‹æ— æ³•å±•å¼€æ‘Šä½çš„é—®é¢˜ï¼‰
        function toggleStall(canteenName, stallName) {
            const canteen = canteensData.find(c => c.name === canteenName);
            if (!canteen) return;
            
            // åœ¨åŸå§‹æ•°æ®ä¸­æŸ¥æ‰¾å¯¹åº”æ‘Šä½
            const originalStall = canteen.stalls.find(s => s.name === stallName);
            if (!originalStall) return;
            
            // åˆ‡æ¢åŸå§‹æ•°æ®çš„æŠ˜å çŠ¶æ€
            if (originalStall.collapsed) {
                // å±•å¼€å½“å‰æ‘Šä½ï¼ŒæŠ˜å åŒé¤é¥®å¤§æ¥¼å†…å…¶ä»–æ‘Šä½
                canteen.stalls.forEach(stall => {
                    stall.collapsed = true;
                });
                originalStall.collapsed = false;
            } else {
                // æŠ˜å å½“å‰æ‘Šä½
                originalStall.collapsed = true;
            }
            
            // é‡æ–°åº”ç”¨ç­›é€‰æ¡ä»¶ä»¥æ›´æ–°æ˜¾ç¤º
            applyAllFilters();
        }

        // æ˜¾ç¤ºè¯„è®ºå¼¹çª—ï¼ˆä¿®å¤ç´¢å¼•é”™ä½é—®é¢˜ï¼‰
        function showComments(canteenName, stallName, dishIndex, type) {
            const canteen = canteensData.find(c => c.name === canteenName);
            if (!canteen) return;

            const stall = canteen.stalls.find(s => s.name === stallName);
            if (!stall) return;

            let targetData;
            if (type === 'dish') {
                if (!stall.dishes[dishIndex]) return;
                targetData = stall.dishes[dishIndex];
            } else {
                targetData = stall;
            }

            if (!targetData) return;

            const uniqueId = generateUniqueId(canteenName, stallName, dishIndex, type);
            const hasUserReviewed = hasReviewed(uniqueId);

            currentModalData = {
                canteenName,
                stallName,
                dishIndex,
                type,
                data: targetData,
                uniqueId,
                hasUserReviewed
            };

            // æ›´æ–°å¼¹çª—å†…å®¹
            document.getElementById('modalTitle').textContent = `${canteenName} - ${targetData.name}`;
            document.getElementById('modalRating').textContent = `${targetData.rating}â­`;
            
            // æ˜¾ç¤ºè¯„è®º - æ‰€æœ‰ç”¨æˆ·è¯„ä»·äº’ç›¸å¯è§
            const commentsList = document.getElementById('commentsList');
            const dishId = getDishId(canteenName, stallName, dishIndex);
            const dishComments = allComments[dishId] || {};
            
            // å°†è¯„è®ºè½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
            const commentsArray = Object.values(dishComments).sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (commentsArray.length > 0) {
                commentsList.innerHTML = commentsArray.map(comment => {
                    // æ ‡è®°å½“å‰ç”¨æˆ·çš„è¯„è®º
                    const isCurrentUser = currentUser && comment.userId === currentUser.id;
                    return `
                        <div class="comment ${isCurrentUser ? 'current-user-comment' : ''}">
                            <div class="comment-header">
                                <div class="comment-author">
                                    ${comment.username}
                                    ${isCurrentUser ? '<span class="current-user-badge">æˆ‘</span>' : ''}
                                </div>
                                <div class="comment-rating">${comment.rating}â­</div>
                            </div>
                            <div class="comment-date">${comment.date}</div>
                            <div class="comment-text">${comment.text}</div>
                        </div>
                    `;
                }).join('');
            } else {
                commentsList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">æš‚æ— è¯„ä»·ï¼Œå¿«æ¥æˆä¸ºç¬¬ä¸€ä¸ªè¯„ä»·çš„äººå§ï¼</p>';
            }

            // æ›´æ–°æ·»åŠ è¯„è®ºåŒºåŸŸ
            const addCommentDiv = document.querySelector('.add-comment');
            if (hasUserReviewed) {
                const userReview = getUserReview(uniqueId);
                const reviewDisplay = userReview ? `
                    <div style="background: #d5f4e6; border-radius: 8px; padding: 15px; margin: 10px 0; border-left: 4px solid #27ae60;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #27ae60; margin: 0;">âœ… æ‚¨çš„è¯„ä»·</h4>
                            <span style="color: #f39c12; font-weight: bold;">${userReview.rating}â­</span>
                        </div>
                        <p style="color: #2c3e50; margin: 0 0 8px 0; line-height: 1.5;">${userReview.text}</p>
                        <div style="color: #7f8c8d; font-size: 0.9em;">è¯„ä»·æ—¶é—´ï¼š${userReview.date}</div>
                    </div>
                ` : `
                    <p style="color: #27ae60; text-align: center; padding: 20px; background: #d5f4e6; border-radius: 8px; margin: 10px 0;">
                        æ„Ÿè°¢æ‚¨çš„è¯„ä»·ï¼æ‚¨å·²ç»å¯¹æ­¤èœå“è¿›è¡Œè¿‡è¯„ä»·äº†ã€‚
                    </p>
                `;
                
                addCommentDiv.innerHTML = `
                    <h4>âœ… æ‚¨å·²è¯„ä»·è¿‡æ­¤èœå“</h4>
                    ${reviewDisplay}
                    <button onclick="clearReview('${uniqueId}')" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9em;">
                        æ¸…é™¤æˆ‘çš„è¯„ä»·
                    </button>
                `;
            } else {
                addCommentDiv.innerHTML = `
                    <h4>âœï¸ æ·»åŠ è¯„ä»·</h4>
                    <form class="comment-form" id="commentForm">
                        <textarea class="comment-input" id="commentText" placeholder="åˆ†äº«ä½ çš„ç”¨é¤ä½“éªŒ..." required></textarea>
                        <select class="rating-input" id="commentRating" required>
                            <option value="">é€‰æ‹©è¯„åˆ†</option>
                            <option value="1">1â­ - å¾ˆå·®</option>
                            <option value="2">2â­ - ä¸€èˆ¬</option>
                            <option value="3">3â­ - è¿˜è¡Œ</option>
                            <option value="4">4â­ - ä¸é”™</option>
                            <option value="5">5â­ - å¾ˆæ£’</option>
                        </select>
                        <button type="submit" class="submit-btn">æäº¤è¯„ä»·</button>
                    </form>
                `;
            }

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('commentModal').style.display = 'block';
        }

        // ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦
        function generateUniqueId(canteenName, stallName, dishIndex, type) {
            return `${canteenName}-${stallName}-${dishIndex}-${type}`;
        }

        // æ£€æŸ¥æ˜¯å¦å·²ç»è¯„ä»·è¿‡
        function hasReviewed(uniqueId) {
            const reviewedItems = JSON.parse(localStorage.getItem('reviewedItems') || '[]');
            return reviewedItems.includes(uniqueId);
        }

        // ä¿å­˜ç”¨æˆ·è¯„ä»·åˆ°æœ¬åœ°å­˜å‚¨
        function saveUserReview(uniqueId, reviewData) {
            const userReviews = JSON.parse(localStorage.getItem('userReviews') || '{}');
            userReviews[uniqueId] = reviewData;
            localStorage.setItem('userReviews', JSON.stringify(userReviews));
        }

        // è·å–ç”¨æˆ·è¯„ä»·
        function getUserReview(uniqueId) {
            const userReviews = JSON.parse(localStorage.getItem('userReviews') || '{}');
            return userReviews[uniqueId] || null;
        }

        // åˆ é™¤ç”¨æˆ·è¯„ä»·
        function deleteUserReview(uniqueId) {
            const userReviews = JSON.parse(localStorage.getItem('userReviews') || '{}');
            delete userReviews[uniqueId];
            localStorage.setItem('userReviews', JSON.stringify(userReviews));
        }

        // æ ‡è®°ä¸ºå·²è¯„ä»·
        function markAsReviewed(uniqueId) {
            const reviewedItems = JSON.parse(localStorage.getItem('reviewedItems') || '[]');
            if (!reviewedItems.includes(uniqueId)) {
                reviewedItems.push(uniqueId);
                localStorage.setItem('reviewedItems', JSON.stringify(reviewedItems));
            }
        }

        // æ·»åŠ æ–°è¯„è®º - æ”¯æŒå¤šç”¨æˆ·
        function addComment() {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•åå†å‘è¡¨è¯„è®ºï¼');
                showLoginModal();
                return;
            }

            const commentText = document.getElementById('commentText').value;
            const commentRating = document.getElementById('commentRating').value;
            
            if (!commentText || !commentRating) {
                alert('è¯·å¡«å†™å®Œæ•´çš„è¯„ä»·ä¿¡æ¯ï¼');
                return;
            }

            if (!currentModalData) return;

            const { canteenName, stallName, dishIndex, type } = currentModalData;
            const dishId = getDishId(canteenName, stallName, dishIndex);
            
            // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»è¯„ä»·è¿‡è¿™ä¸ªèœå“
            if (allComments[dishId] && allComments[dishId][currentUser.id]) {
                alert('æ‚¨å·²ç»è¯„ä»·è¿‡è¿™ä¸ªèœå“äº†ï¼');
                return;
            }

            // åˆ›å»ºæ–°è¯„è®º
            const newComment = {
                username: currentUser.username,
                rating: parseFloat(commentRating),
                text: commentText,
                date: new Date().toLocaleDateString(),
                userId: currentUser.id
            };

            // ä¿å­˜åˆ°å¤šç”¨æˆ·è¯„è®ºç³»ç»Ÿ
            if (!allComments[dishId]) {
                allComments[dishId] = {};
            }
            allComments[dishId][currentUser.id] = newComment;
            saveAllComments();

            // åˆ·æ–°è¯„è®ºæ˜¾ç¤º
            showComments(canteenName, stallName, dishIndex, type);

            // ä¿å­˜ç”¨æˆ·è¯„ä»·åˆ°æœ¬åœ°å­˜å‚¨
            const reviewData = {
                rating: parseFloat(commentRating),
                text: commentText,
                date: new Date().toLocaleDateString(),
                canteenName,
                stallName,
                dishIndex,
                type,
                dishName: targetData.name
            };
            saveUserReview(uniqueId, reviewData);

            // æ ‡è®°ä¸ºå·²è¯„ä»·
            markAsReviewed(uniqueId);

            // æ›´æ–°å¹³å‡è¯„åˆ†
            const totalRating = targetData.comments.reduce((sum, comment) => sum + comment.rating, 0);
            targetData.rating = (totalRating / targetData.comments.length).toFixed(1);

            // å¦‚æœæ˜¯èœå“è¯„è®ºï¼Œè¿˜éœ€è¦æ›´æ–°æ‘Šä½è¯„åˆ†
            if (type === 'dish') {
                stall.rating = calculateStallRating(stall.dishes);
            }

            // é‡æ–°æ¸²æŸ“é¡µé¢
            applyAllFilters();
            
            // æ›´æ–°å¼¹çª—å†…å®¹
            showComments(canteenName, stall.name, dishIndex, type);
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('commentText').value = '';
            document.getElementById('commentRating').value = '';
        }

        // æ¸…é™¤è¯„ä»·
        function clearReview(uniqueId) {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‚¨çš„è¯„ä»·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                const reviewedItems = JSON.parse(localStorage.getItem('reviewedItems') || '[]');
                const index = reviewedItems.indexOf(uniqueId);
                if (index > -1) {
                    reviewedItems.splice(index, 1);
                    localStorage.setItem('reviewedItems', JSON.stringify(reviewedItems));
                }
                
                // åˆ é™¤æœ¬åœ°å­˜å‚¨ä¸­çš„ç”¨æˆ·è¯„ä»·æ•°æ®
                deleteUserReview(uniqueId);
                
                // ä»è¯„è®ºåˆ—è¡¨ä¸­ç§»é™¤ç”¨æˆ·çš„è¯„è®º
                if (currentModalData) {
                    const { canteenName, stallName, dishIndex, type } = currentModalData;
                    const canteen = canteensData.find(c => c.name === canteenName);
                    if (canteen) {
                        const stall = canteen.stalls.find(s => s.name === stallName);
                        if (stall) {
                            let targetData;
                            if (type === 'dish') {
                                targetData = stall.dishes[dishIndex];
                            } else {
                                targetData = stall;
                            }
                            
                            if (targetData && targetData.comments) {
                                // ç§»é™¤ç”¨æˆ·åä¸º"æˆ‘"çš„è¯„è®º
                                targetData.comments = targetData.comments.filter(comment => comment.author !== 'æˆ‘');
                                
                                // é‡æ–°è®¡ç®—è¯„åˆ†
                                if (targetData.comments.length > 0) {
                                    const totalRating = targetData.comments.reduce((sum, comment) => sum + comment.rating, 0);
                                    targetData.rating = (totalRating / targetData.comments.length).toFixed(1);
                                } else {
                                    targetData.rating = '3.0';
                                }
                                
                                // å¦‚æœæ˜¯èœå“è¯„è®ºï¼Œè¿˜éœ€è¦æ›´æ–°æ‘Šä½è¯„åˆ†
                                if (type === 'dish') {
                                    stall.rating = calculateStallRating(stall.dishes);
                                }
                            }
                        }
                    }
                }
                
                // é‡æ–°æ¸²æŸ“é¡µé¢
                applyAllFilters();
                
                // é‡æ–°æ˜¾ç¤ºå¼¹çª—
                if (currentModalData) {
                    showComments(currentModalData.canteenName, currentModalData.stallName, currentModalData.dishIndex, currentModalData.type);
                }
            }
        }

        // å…³é—­å¼¹çª—
        function closeModal() {
            document.getElementById('commentModal').style.display = 'none';
            currentModalData = null;
        }

        // åŠ è½½ç”¨æˆ·è¯„ä»·
        function loadUserReviews() {
            const userReviews = JSON.parse(localStorage.getItem('userReviews') || '{}');
            
            Object.keys(userReviews).forEach(uniqueId => {
                const reviewData = userReviews[uniqueId];
                const { canteenName, stallName, dishIndex, type, rating, text, date } = reviewData;
                
                // æ‰¾åˆ°å¯¹åº”çš„èœå“
                const canteen = canteensData.find(c => c.name === canteenName);
                if (!canteen) return;
                
                const stall = canteen.stalls.find(s => s.name === stallName);
                if (!stall) return;
                
                let targetData;
                if (type === 'dish') {
                    targetData = stall.dishes[dishIndex];
                } else {
                    targetData = stall;
                }
                
                if (!targetData) return;
                
                // ç¡®ä¿è¯„è®ºæ•°ç»„å­˜åœ¨
                if (!targetData.comments) {
                    targetData.comments = [];
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç”¨æˆ·çš„è¯„è®ºï¼ˆé¿å…é‡å¤æ·»åŠ ï¼‰
                const existingUserComment = targetData.comments.find(comment => comment.author === 'æˆ‘');
                if (!existingUserComment) {
                    // æ·»åŠ ç”¨æˆ·è¯„è®º
                    const userComment = {
                        author: 'æˆ‘',
                        rating: rating,
                        text: text,
                        date: date
                    };
                    targetData.comments.unshift(userComment);
                }
                
                // é‡æ–°è®¡ç®—è¯„åˆ†
                const totalRating = targetData.comments.reduce((sum, comment) => sum + comment.rating, 0);
                targetData.rating = (totalRating / targetData.comments.length).toFixed(1);
                
                // å¦‚æœæ˜¯èœå“è¯„è®ºï¼Œè¿˜éœ€è¦æ›´æ–°æ‘Šä½è¯„åˆ†
                if (type === 'dish') {
                    stall.rating = calculateStallRating(stall.dishes);
                }
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ¸²æŸ“
        document.addEventListener('DOMContentLoaded', function() {
            // é¦–å…ˆåŠ è½½ç”¨æˆ·è¯„ä»·
            loadUserReviews();
            // ç„¶ååº”ç”¨ç­›é€‰æ¡ä»¶
            applyAllFilters();

            // å¢å¼ºæœç´¢åŠŸèƒ½ - é˜²æŠ–æœç´¢
            let searchTimeout;
            const searchInput = document.getElementById('searchInput');
            
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchCanteens(e.target.value);
                }, 300);
            });
            
            // å›è½¦é”®æœç´¢
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearch();
                }
            });

            // å¼¹çª—å…³é—­åŠŸèƒ½
            document.querySelector('.close').addEventListener('click', closeModal);
            window.addEventListener('click', function(e) {
                const modal = document.getElementById('commentModal');
                if (e.target === modal) {
                    closeModal();
                }
            });

            // è¯„è®ºè¡¨å•æäº¤ - ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åŠ¨æ€ç”Ÿæˆçš„è¡¨å•
            document.addEventListener('submit', function(e) {
                if (e.target.id === 'commentForm') {
                    e.preventDefault();
                    addComment();
                }
            });
        });

        // æ·»åŠ ä¸€äº›äº¤äº’æ•ˆæœ
        document.addEventListener('DOMContentLoaded', function() {
            // ä¸ºèœå“å¡ç‰‡æ·»åŠ ç‚¹å‡»æ•ˆæœ
            document.addEventListener('click', function(e) {
                if (e.target.closest('.dish')) {
                    const dish = e.target.closest('.dish');
                    dish.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        dish.style.transform = 'scale(1)';
                    }, 150);
                }
            });
        });
        // æœç´¢å»ºè®®åŠŸèƒ½
        function initSearchSuggestions() {
            const searchInput = document.getElementById('searchInput');
            const suggestions = [
                'ç•ªèŒ„é¸¡è›‹', 'çº¢çƒ§è‚‰', 'é…¸è¾£åœŸè±†ä¸',
                'å®«ä¿é¸¡ä¸', 'é±¼é¦™è‚‰ä¸', 'éº»å©†è±†è…', 'æ°´ç…®é±¼', 'å›é”…è‚‰',
                'ç‰›è‚‰ç²‰ä¸æ±¤', 'é¦™é…¥è„†é¥¼', 'è‘±æ²¹é¥¼', 'é›ªèœè‚‰ä¸é¢',
                'é±¼é¦™è‚‰ä¸å¥—é¤é¥­', 'æ²™èŒ¶ç‰›è‚‰ç‚’é¥­', 'æ‰¬å·ç‚’é¥­', 'å°åº¦å’–å–±é¸¡é¥­',
                'ç¬¬ä¸€é¤é¥®å¤§æ¥¼', 'ç¬¬äºŒé¤é¥®å¤§æ¥¼', 'ç¬¬ä¸‰é¤é¥®å¤§æ¥¼', 'ç¬¬å››é¤é¥®å¤§æ¥¼', 'ç¬¬äº”é¤é¥®å¤§æ¥¼'
            ];

            let suggestionsDiv = document.getElementById('searchSuggestions');
            if (!suggestionsDiv) {
                suggestionsDiv = document.createElement('div');
                suggestionsDiv.id = 'searchSuggestions';
                suggestionsDiv.style.cssText = `
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                    z-index: 1000;
                    max-height: 200px;
                    overflow-y: auto;
                    display: none;
                `;
                
                const searchBar = document.querySelector('.search-bar');
                if (searchBar) {
                    searchBar.style.position = 'relative';
                    searchBar.appendChild(suggestionsDiv);
                }
            }

            // æœç´¢å»ºè®®äº‹ä»¶å¤„ç†
            searchInput.addEventListener('focus', function() {
                if (this.value.length > 0) {
                    showFilteredSuggestions(this.value, suggestions);
                } else {
                    showAllSuggestions(suggestions);
                }
            });

            searchInput.addEventListener('input', function() {
                if (this.value.length > 0) {
                    showFilteredSuggestions(this.value, suggestions);
                } else {
                    showAllSuggestions(suggestions);
                }
            });

            searchInput.addEventListener('blur', function() {
                setTimeout(() => {
                    suggestionsDiv.style.display = 'none';
                }, 200);
            });

            function showAllSuggestions(suggestions) {
                suggestionsDiv.innerHTML = suggestions.map(suggestion => `
                    <div style="padding: 8px 15px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;"
                         onmouseover="this.style.background='#f8f9fa'"
                         onmouseout="this.style.background='white'"
                         onclick="document.getElementById('searchInput').value='${suggestion}'; searchCanteens('${suggestion}')">
                        <span style="color: #3498db;">ğŸ’¡</span> ${suggestion}
                    </div>
                `).join('');
                suggestionsDiv.style.display = 'block';
            }

            function showFilteredSuggestions(query, suggestions) {
                const filtered = suggestions.filter(s => 
                    s.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 8);
                
                if (filtered.length > 0) {
                    suggestionsDiv.innerHTML = filtered.map(suggestion => `
                        <div style="padding: 8px 15px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;"
                             onmouseover="this.style.background='#f8f9fa'"
                             onmouseout="this.style.background='white'"
                             onclick="document.getElementById('searchInput').value='${suggestion}'; searchCanteens('${suggestion}')">
                            <span style="color: #3498db;">ğŸ”</span> ${suggestion}
                        </div>
                    `).join('');
                    suggestionsDiv.style.display = 'block';
                } else {
                    suggestionsDiv.style.display = 'none';
                }
            }
        }

        // æœç´¢å¿«æ·é”®æ”¯æŒ
        function initSearchShortcuts() {
            const searchInput = document.getElementById('searchInput');
            
            document.addEventListener('keydown', function(e) {
                if (e.key === '/' && !e.ctrlKey && !e.altKey && !e.metaKey) {
                    if (document.activeElement !== searchInput) {
                        e.preventDefault();
                        searchInput.focus();
                    }
                }
                
                if (e.key === 'Escape') {
                    if (document.activeElement === searchInput) {
                        searchInput.blur();
                        searchInput.value = '';
                        searchCanteens('');
                    }
                }
            });
        }

        // å¢å¼ºçš„æœç´¢ç»Ÿè®¡åŠŸèƒ½
        function updateSearchStats(query, results) {
            const totalDishes = results.reduce((sum, canteen) => 
                sum + canteen.stalls.reduce((stallSum, stall) => 
                    stallSum + stall.dishes.length, 0), 0);
            
            let statsDiv = document.getElementById('searchStats');
            if (!statsDiv) {
                statsDiv = document.createElement('div');
                statsDiv.id = 'searchStats';
                statsDiv.style.cssText = `
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 12px 18px;
                    margin: 10px 0;
                    border-radius: 10px;
                    font-size: 14px;
                    font-weight: 500;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    transition: all 0.3s ease;
                `;
                
                const searchBar = document.querySelector('.search-bar');
                if (searchBar) {
                    searchBar.appendChild(statsDiv);
                }
            }
            
            if (query && query.trim()) {
                if (totalDishes > 0) {
                    statsDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>ğŸ”</span>
                            <span>æœç´¢ "<strong>${query}</strong>" æ‰¾åˆ° <strong>${totalDishes}</strong> é“èœå“ï¼Œåˆ†å¸ƒåœ¨ <strong>${results.length}</strong> æ ‹é¤é¥®å¤§æ¥¼</span>
                            <button onclick="clearSearch()" style="margin-left: auto; background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">æ¸…é™¤</button>
                        </div>
                    `;
                    statsDiv.style.display = 'block';
                } else {
                    statsDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>ğŸ˜…</span>
                            <span>æœç´¢ "<strong>${query}</strong>" æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</span>
                            <button onclick="clearSearch()" style="margin-left: auto; background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">æ¸…é™¤</button>
                        </div>
                    `;
                    statsDiv.style.display = 'block';
                }
            } else {
                statsDiv.style.display = 'none';
            }
        }

        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            
            // éšè—æœç´¢ç»Ÿè®¡
            const searchStats = document.getElementById('searchStats');
            if (searchStats) {
                searchStats.style.display = 'none';
            }
            
            // æ¸…é™¤æœç´¢å¹¶é‡æ–°æ¸²æŸ“
            searchCanteens('');
            
            // é‡æ–°åº”ç”¨ç­›é€‰æ¡ä»¶
            applyAllFilters();
            
            searchInput.focus();
        }

        // æ‰§è¡Œæœç´¢åŠŸèƒ½
        function performSearch() {
            const searchInput = document.getElementById('searchInput');
            const query = searchInput.value.trim();
            
            // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œä¸æ‰§è¡Œæœç´¢ï¼Œç›´æ¥æ˜¾ç¤ºæ‰€æœ‰å†…å®¹
            if (query === '') {
                clearSearch();
                return;
            }
            
            searchCanteens(query);
        }

        // ç­›é€‰åŠŸèƒ½ç›¸å…³å‡½æ•°
        function showFilterModal() {
            document.getElementById('filterModal').style.display = 'block';
            currentStep = 1;
            filterSettings = { spicy: null, location: null, priority: null };
            showStep(1);
        }

        function closeFilterModal() {
            document.getElementById('filterModal').style.display = 'none';
        }

        function showStep(step) {
            // éšè—æ‰€æœ‰æ­¥éª¤
            document.querySelectorAll('.filter-step').forEach(s => s.classList.remove('active'));
            // æ˜¾ç¤ºå½“å‰æ­¥éª¤
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
        }

        function nextStep(step) {
            showStep(step);
        }

        function prevStep(step) {
            showStep(step);
        }

        function selectSpicy(spicy) {
            filterSettings.spicy = spicy;
            updateSelection('step1', spicy);
            document.getElementById('nextBtn1').disabled = false;
        }

        function selectLocation(location) {
            filterSettings.location = location;
            updateSelection('step2', location);
            document.getElementById('nextBtn2').disabled = false;
        }

        function selectPriority(priority) {
            filterSettings.priority = priority;
            updateSelection('step3', priority);
        }

        function updateSelection(stepId, value) {
            const step = document.getElementById(stepId);
            step.querySelectorAll('.filter-option').forEach(option => {
                option.classList.remove('selected');
                if (option.textContent.trim() === value) {
                    option.classList.add('selected');
                }
            });
        }

        function applyFilter() {
            closeFilterModal();
            
            // è·å–æ‰€æœ‰èœå“å¹¶è®¡ç®—è¯„åˆ†
            const allDishes = [];
            canteensData.forEach(canteen => {
                canteen.stalls.forEach(stall => {
                    stall.dishes.forEach(dish => {
                        // æ·»åŠ é¤é¥®å¤§æ¥¼ä¿¡æ¯
                        dish.canteenName = canteen.name;
                        dish.stallName = stall.name;
                        allDishes.push(dish);
                    });
                });
            });

            // åº”ç”¨ç­›é€‰æ¡ä»¶
            let filteredDishes = allDishes;

            // è¾£åº¦ç­›é€‰
            if (filterSettings.spicy === 'è¾£') {
                filteredDishes = filteredDishes.filter(dish => 
                    dish.spicy === 'å¾®è¾£' || dish.spicy === 'ä¸­è¾£' || dish.spicy === 'éº»è¾£'
                );
            } else if (filterSettings.spicy === 'ä¸è¾£') {
                filteredDishes = filteredDishes.filter(dish => dish.spicy === 'ä¸è¾£');
            }
            // å¦‚æœé€‰æ‹©"è¾£ä¸è¾£çš†å¯"ï¼Œåˆ™ä¸è¿›è¡Œç­›é€‰

            // ä½ç½®è¯„åˆ† (aå€¼)
            filteredDishes.forEach(dish => {
                let a = 0;
                if (filterSettings.location === 'ä¸œ34å®¿èˆ') {
                    if (dish.canteenName.includes('ç¬¬1é¤é¥®å¤§æ¥¼')) a = 0;
                    else if (dish.canteenName.includes('ç¬¬2é¤é¥®å¤§æ¥¼')) a = 0.5;
                    else a = 1;
                } else if (filterSettings.location === 'ä¸Š/ä¸­/ä¸‹é™¢') {
                    if (dish.canteenName.includes('ç¬¬3é¤é¥®å¤§æ¥¼')) a = 0;
                    else if (dish.canteenName.includes('ç¬¬2é¤é¥®å¤§æ¥¼')) a = 0.5;
                    else a = 1;
                } else if (filterSettings.location === 'ä¸œä¸Š/ä¸­/ä¸‹é™¢') {
                    if (dish.canteenName.includes('ç¬¬1é¤é¥®å¤§æ¥¼')) a = 0;
                    else if (dish.canteenName.includes('ç¬¬3é¤é¥®å¤§æ¥¼')) a = 0.5;
                    else a = 1;
                }
                dish.a = a;
            });

            // å£å‘³è¯„åˆ† (bå€¼)
            filteredDishes.forEach(dish => {
                dish.b = parseFloat(dish.rating) / 5;
            });

            // ç»¼åˆè¯„åˆ† (cå€¼)
            filteredDishes.forEach(dish => {
                let c = 0;
                if (filterSettings.priority === 'æ—¶é—´ä¸ºé‡') {
                    c = dish.a * 0.8 + dish.b * 0.2;
                } else if (filterSettings.priority === 'å£å‘³ä¸ºé‡') {
                    c = dish.a * 0.2 + dish.b * 0.8;
                } else if (filterSettings.priority === 'äºŒè€…å…¼é¡¾') {
                    c = dish.a * 0.5 + dish.b * 0.5;
                }
                dish.c = c;
            });

            // æŒ‰cå€¼ä»å¤§åˆ°å°æ’åº
            filteredDishes.sort((a, b) => b.c - a.c);

            // æ¸²æŸ“ç­›é€‰ç»“æœ
            renderFilteredDishes(filteredDishes);
        }

        function renderFilteredDishes(dishes) {
            const grid = document.getElementById('canteenGrid');
            grid.innerHTML = '';

            if (dishes.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                        <h3>ğŸ˜… æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„èœå“</h3>
                        <p>è¯·å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶</p>
                    </div>
                `;
                return;
            }

            // åˆ›å»ºç­›é€‰ç»“æœæ ‡é¢˜
            const resultHeader = document.createElement('div');
            resultHeader.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 15px;
                margin-bottom: 20px;
                text-align: center;
            `;
            resultHeader.innerHTML = `
                <h2>ğŸ¯ ç­›é€‰ç»“æœ</h2>
                <p>å…±æ‰¾åˆ° ${dishes.length} é“ç¬¦åˆæ‚¨åå¥½çš„èœå“ï¼ŒæŒ‰æ¨èåº¦æ’åº</p>
                <button onclick="clearFilter()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; margin-top: 10px;">æ¸…é™¤ç­›é€‰</button>
            `;
            grid.appendChild(resultHeader);

            // åˆ›å»ºèœå“åˆ—è¡¨
            const dishesContainer = document.createElement('div');
            dishesContainer.style.cssText = `
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
            `;

            dishes.forEach((dish, index) => {
                const dishCard = document.createElement('div');
                dishCard.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 20px;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                    border-left: 4px solid #3498db;
                    transition: transform 0.3s ease;
                    cursor: pointer;
                `;
                dishCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <h3 style="color: #2c3e50; margin: 0; font-size: 1.2em;">${dish.name}</h3>
                        <span style="background: #f39c12; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.9em; font-weight: bold;">
                            #${index + 1}
                        </span>
                    </div>
                    <div style="color: #e74c3c; font-weight: bold; font-size: 1.1em; margin-bottom: 8px;">Â¥${dish.price}</div>
                    <div style="margin-bottom: 10px;">
                        <span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; margin-right: 5px;">${dish.spicy}</span>
                        ${dish.attributes.map(attr => `
                            <span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; margin-right: 5px;">${attr}</span>
                        `).join('')}
                    </div>
                    <div style="color: #7f8c8d; font-size: 0.9em; margin-bottom: 8px;">
                        ğŸ“ ${dish.canteenName} - ${dish.stallName}
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #f39c12; font-weight: bold;">${dish.rating}â­</span>
                        <span style="color: #27ae60; font-size: 0.9em; font-weight: bold;">
                            æ¨èåº¦: ${(dish.c * 100).toFixed(1)}%
                        </span>
                    </div>
                `;
                dishCard.addEventListener('click', () => {
                    // æ‰¾åˆ°å¯¹åº”çš„èœå“å¹¶æ‰“å¼€è¯„è®ºç•Œé¢
                    const targetCanteen = canteensData.find(c => c.name === dish.canteenName);
                    if (targetCanteen) {
                        const targetStall = targetCanteen.stalls.find(s => s.name === dish.stallName);
                        if (targetStall) {
                            const dishIndex = targetStall.dishes.findIndex(d => d.name === dish.name);
                            if (dishIndex !== -1) {
                                // ç›´æ¥æ‰“å¼€è¯„è®ºç•Œé¢
                                showComments(dish.canteenName, dish.stallName, dishIndex, 'dish');
                                return;
                            }
                        }
                    }
                    // å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”èœå“ï¼Œåˆ™å±•å¼€æ‘Šä½
                    const fallbackCanteen = canteensData.find(c => c.name === dish.canteenName);
                    if (fallbackCanteen) {
                        fallbackCanteen.collapsed = false;
                        const fallbackStall = fallbackCanteen.stalls.find(s => s.name === dish.stallName);
                        if (fallbackStall) {
                            fallbackCanteen.stalls.forEach(s => s.collapsed = true);
                            fallbackStall.collapsed = false;
                        }
                    }
                    clearFilter();
                });
                dishesContainer.appendChild(dishCard);
            });

            grid.appendChild(dishesContainer);
        }

        function clearFilter() {
            applyAllFilters();
        }

        // ç˜¦èº«ç­›é€‰åŠŸèƒ½
        function toggleSlimFilter() {
            slimFilterActive = !slimFilterActive;
            const btn = document.getElementById('slimBtn');
            if (slimFilterActive) {
                btn.classList.add('active');
                btn.textContent = 'ç˜¦èº« âœ“';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'ç˜¦èº«';
            }
            applyAllFilters();
        }

        // å¥èº«ç­›é€‰åŠŸèƒ½
        function toggleFitnessFilter() {
            fitnessFilterActive = !fitnessFilterActive;
            const btn = document.getElementById('fitnessBtn');
            if (fitnessFilterActive) {
                btn.classList.add('active');
                btn.textContent = 'å¥èº« âœ“';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'å¥èº«';
            }
            applyAllFilters();
        }

        // ç§»åŠ¨ç«¯ä¼˜åŒ–åŠŸèƒ½
        function initMobileOptimizations() {
            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // ç¦ç”¨åŒå‡»ç¼©æ”¾
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function (event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
                
                // ä¼˜åŒ–è§¦æ‘¸æ»šåŠ¨
                document.body.style.webkitOverflowScrolling = 'touch';
                
                // æ·»åŠ è§¦æ‘¸åé¦ˆ
                document.addEventListener('touchstart', function(e) {
                    if (e.target.classList.contains('dish') || 
                        e.target.classList.contains('stall-header') ||
                        e.target.classList.contains('filter-btn') ||
                        e.target.classList.contains('toggle-btn')) {
                        e.target.style.opacity = '0.7';
                    }
                });
                
                document.addEventListener('touchend', function(e) {
                    if (e.target.classList.contains('dish') || 
                        e.target.classList.contains('stall-header') ||
                        e.target.classList.contains('filter-btn') ||
                        e.target.classList.contains('toggle-btn')) {
                        setTimeout(() => {
                            e.target.style.opacity = '1';
                        }, 100);
                    }
                });
                
                // ä¼˜åŒ–æœç´¢å»ºè®®åœ¨ç§»åŠ¨ç«¯çš„æ˜¾ç¤º
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('focus', function() {
                        // åœ¨ç§»åŠ¨ç«¯èšç„¦æ—¶æ»šåŠ¨åˆ°æœç´¢æ¡†
                        setTimeout(() => {
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    });
                }
                
                // ä¼˜åŒ–å¼¹çª—åœ¨ç§»åŠ¨ç«¯çš„æ˜¾ç¤º
                const modals = document.querySelectorAll('.modal, .filter-modal');
                modals.forEach(modal => {
                    modal.addEventListener('show', function() {
                        document.body.style.overflow = 'hidden';
                    });
                    
                    modal.addEventListener('hide', function() {
                        document.body.style.overflow = 'auto';
                    });
                });
            }
        }
        
        // ç§»åŠ¨ç«¯æ‰‹åŠ¿æ”¯æŒ
        function initMobileGestures() {
            let startY = 0;
            let startX = 0;
            
            document.addEventListener('touchstart', function(e) {
                startY = e.touches[0].clientY;
                startX = e.touches[0].clientX;
            });
            
            document.addEventListener('touchmove', function(e) {
                const currentY = e.touches[0].clientY;
                const currentX = e.touches[0].clientX;
                const diffY = startY - currentY;
                const diffX = startX - currentX;
                
                // æ£€æµ‹å·¦å³æ»‘åŠ¨ï¼ˆç”¨äºå¯èƒ½çš„é¡µé¢åˆ‡æ¢åŠŸèƒ½ï¼‰
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å·¦å³æ»‘åŠ¨åˆ‡æ¢é¤é¥®å¤§æ¥¼çš„åŠŸèƒ½
                }
            });
        }
        
        // ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–
        function initMobilePerformance() {
            // å»¶è¿ŸåŠ è½½éå…³é”®å†…å®¹
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('loaded');
                    }
                });
            });
            
            // è§‚å¯Ÿæ‰€æœ‰èœå“å¡ç‰‡
            document.addEventListener('DOMContentLoaded', function() {
                const dishes = document.querySelectorAll('.dish');
                dishes.forEach(dish => {
                    observer.observe(dish);
                });
            });
        }

        // åˆå§‹åŒ–æ‰€æœ‰æœç´¢åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ç”¨æˆ·ç³»ç»Ÿ
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUserInterface();
            }
            
            // åŠ è½½æ‰€æœ‰è¯„è®º
            loadAllComments();
            
            initSearchSuggestions();
            initSearchShortcuts();
            initMobileOptimizations();
            initMobileGestures();
            initMobilePerformance();
        });
    </script>
</body>
</html>
